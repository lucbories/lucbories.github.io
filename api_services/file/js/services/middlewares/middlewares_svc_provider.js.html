<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">js/services/middlewares/middlewares_svc_provider.js | Devapt (Developper Application Toolkit) Core Common</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Common features for Devapt libraries and applications."><meta property="og:type" content="website"><meta property="og:url" content="http://www.devapt.org"><meta property="og:site_name" content="Devapt (Developper Application Toolkit) Core Common"><meta property="og:title" content="Devapt (Developper Application Toolkit) Core Common"><meta property="og:image" content="https://avatars3.githubusercontent.com/u/21240408?v=4&amp;s=200"><meta property="og:description" content="Common features for Devapt libraries and applications."><meta property="og:author" content="https://github.com/lucbories"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Devapt (Developper Application Toolkit) Core Common"><meta property="twitter:description" content="Common features for Devapt libraries and applications."><meta property="twitter:image" content="https://avatars3.githubusercontent.com/u/21240408?v=4&amp;s=200"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/lucbories/devapt-core-common"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#default-plugins">default_plugins</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/default_plugins/services_default_plugin.js~DefaultServicesPlugin.html">DefaultServicesPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#executables">executables</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_command.js~ExecutableCommand.html">ExecutableCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_route.js~ExecutableRoute.html">ExecutableRoute</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-assets">services/assets</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/assets_svc_provider.js~AssetsSvcProvider.html">AssetsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/executable_route_assets.js~ExecutableRouteAssets.html">ExecutableRouteAssets</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-logs">services/logs</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-messages">services/messages</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-metrics">services/metrics</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics/metrics_svc_provider.js~MetricsSvcProvider.html">MetricsSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-middlewares">services/middlewares</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middlewares/executable_route_middleware.js~ExecutableRouteMiddleware.html">ExecutableRouteMiddleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middlewares/middlewares_svc_provider.js~MiddlewaresSvcProvider.html">MiddlewaresSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-ping">services/ping</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/ping/ping_svc_provider.js~PingSvcProvider.html">PingSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-resources">services/resources</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resources/executable_route_get_resource.js~ExecutableRouteGetResources.html">ExecutableRouteGetResources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resources/resources_svc_provider.js~ResourcesSvcProvider.html">ResourcesSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-security">services/security</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_service.js~SecurityService.html">SecurityService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_consumer.js~SecuritySvcConsumer.html">SecuritySvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_provider.js~SecuritySvcProvider.html">SecuritySvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-todo-crud">services/todo_crud</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/crud_service.js~CrudService.html">CrudService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/crud_svc_consumer.js~CrudSvcConsumer.html">CrudSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/crud_svc_provider.js~CrudSvcProvider.html">CrudSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/executable_route_model_crud.js~ExecutableRouteModelCrud.html">ExecutableRouteModelCrud</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-topology">services/topology</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_service.js~TopologyService.html">TopologyService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_consumer.js~TopologySvcHostConsumer.html">TopologySvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/services/middlewares/middlewares_svc_provider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
import assert from &apos;assert&apos;
import {format} from &apos;util&apos;

// COMMON IMPORTS
import T                from &apos;devapt-core-common/dist/js/utils/types&apos;
import ServiceProvider  from &apos;devapt-core-common/dist/js/services/service_provider&apos;
import ServiceResponse  from &apos;devapt-core-common/dist/js/services/service_response&apos;
import RenderingBuilder from &apos;devapt-core-common/dist/js/rendering/rendering_builder&apos;

// SERVICES IMPORTS
import ExecutableRouteMiddleware from &apos;./executable_route_middleware&apos;


/**
 * Contextual constant for this file logs.
 * @private
 */
const context = &apos;server/services/middlewares/middlewares_svc_provider&apos;



/**
 * Middlewares service provider class.
 * 
 * @author Luc BORIES
 * @license Apache-2.0
 */
export default class MiddlewaresSvcProvider extends ServiceProvider
{
	/**
	 * Create a middleware service provider.
	 * 
	 * @param {string} arg_provider_name - consumer name.
	 * @param {Service} arg_service_instance - service instance.
	 * @param {string} arg_context - logging context label.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_provider_name, arg_service_instance, arg_context)
	{
		super(arg_provider_name, arg_service_instance, arg_context ? arg_context : context)
		
		/**
		 * Class test flag.
		 * @type {boolean}
		 */
		this.is_middleware_svc_provider = true
		
		/**
		 * Service executable instance.
		 * @type {Executable}
		 */
		this.exec = new ExecutableRouteMiddleware()
		this.exec.service = this.service
	}



	/**
	 * Get provider operations names.
	 * @abstract
	 * 
	 * @returns {array}
	 */
	get_operations_names()
	{
		return [&apos;devapt-mw-list&apos;, &apos;devapt-mw-get&apos;]
	}


	
	/**
	 * Produce service datas on request.
	 * 
	 * @param {ServiceRequest} arg_request - service request instance.
	 * 
	 * @returns {Promise} - promise of ServiceResponse instance.
	 */
	produce(arg_request)
	{
		this.enter_group(&apos;produce&apos;)

		if ( ! T.isObject(arg_request) || ! arg_request.is_service_request)
		{
			this.leave_group(&apos;produce:error:bad request object.&apos;)
			return Promise.resolve({error:&apos;bad request object&apos;})
		}

		const response = new ServiceResponse(arg_request)
		const operation = arg_request.get_operation()
		const operands = arg_request.get_operands()
		const credentials = arg_request.get_credentials()

		// CHECK OPERANDS
		if ( ! T.isNotEmptyArray(operands) )
		{
			return Promise.resolve(undefined)
		}
		
		// DEBUG
		const debug_msg = format(&apos;produce:service[%s] operation[%s] operands count[%d]&apos;, response.get_service(), operation, operands.length)
		// console.log(context + debug_msg)
		this.debug(debug_msg)


		// GET TARGET ROUTE
		const opd_1 = operands.length &gt; 0 ? operands[0] : undefined
		const opd_1_route = T.isObject(opd_1) ? opd_1.route : opd_1
		let target_route = opd_1_route &amp;&amp; T.isNotEmptyString(opd_1_route) ? opd_1_route : undefined
		if ( ! target_route)
		{
			this.fill_error(response, operands, &apos;bad middleware route string&apos;)
			return Promise.resolve(response)
		}
		target_route = target_route.endsWith(&apos;/&apos;) ? target_route.slice(0, target_route.length - 1) : target_route
		
		// GET ROUTES
		const routes = this.get_setting_js(&apos;routes&apos;, [])
		// console.log(debug_msg + &apos;:target_route=&apos;, target_route)

		switch(operation) {
			case &apos;get&apos;: {
				let renderer_result_json = undefined

				// SEARCH ROUTE
				let route_mw_file = undefined
				let route_page_view = undefined
				let route_page_menubar = undefined

				// TODO REPLACE FOREACH TO END LOOP ON FOUND
				routes.forEach(
					(route_cfg)=&gt;{
						const loop_route = route_cfg.route.endsWith(&apos;/&apos;) ? route_cfg.route.slice(0, target_route.length - 1) : route_cfg.route
						if (loop_route == target_route)
						{
							route_mw_file = route_cfg.mw_file
							route_page_view = route_cfg.page_view
							route_page_menubar = route_cfg.page_menubar

							console.log(context + &apos;:process:target_route found&apos;)
						}
					}
				)

				try {
					// PROCESS MIDDLEWARE FILE
					if ( T.isString(route_mw_file) )
					{
						console.log(context + &apos;:process:route_mw_file found&apos;, route_mw_file)

						renderer_result_json = this.process_mw_file(route_mw_file, credentials)

						response.set_results( [renderer_result_json] )

						this.leave_group( format(&apos;produce:middleware file:service[%s] operation[%s]&apos;, response.get_service(), operation) )
						return Promise.resolve(response)
					}

					// VIEW RENDERING MIDDLEWARE
					if ( T.isString(route_page_view) )
					{
						console.log(context + &apos;:process:route_page_view found&apos;, route_page_view)

						renderer_result_json = this.process_mw_view(route_page_view, route_page_menubar, credentials)

						response.set_results( [renderer_result_json] )

						this.leave_group( format(&apos;produce:view rendering:service[%s] operation[%s]&apos;, response.get_service(), operation) )
						return Promise.resolve(response)
					}

					// BAD ROUTE CONFIG
					this.fill_error(response, operands, &apos;route not found for target&apos;, target_route)
					return Promise.resolve(response)
				}
				catch(e)
				{
					this.fill_error(response, operands, &apos;exception for target&apos;, target_route, e)
					return Promise.resolve(response)
				}
			}
		}

		this.fill_error(response, operands, &apos;bad operation&apos;, target_route)
		return Promise.resolve(response)
	}



	/**
	 * Process a middleware file.
	 * 
	 * @param {string} arg_mw_file - middleware file.
	 * @param {Credentials} arg_credentials - request credentials.
	 * 
	 * @returns {object} - JSON rendering result.
	 */
	process_mw_file(arg_mw_file, arg_credentials)
	{
		this.enter_group(&apos;process_mw_file:&apos; + arg_mw_file)
		assert( T.isString(arg_mw_file), context + &apos;:process_mw_file:bad file string&apos;)
		
		let mw_cfg = undefined

		// CHECK PATH
		const path_file_name = this.get_runtime().context.get_absolute_path(arg_mw_file)
		assert(T.isString(path_file_name), context + &apos;:bad middleware file path string&apos;)
		
		// LOAD MIDDLEWARE FILE
		try {
			this.info(&apos;Loading middleware file&apos;)
			
			mw_cfg = require(path_file_name).service_cfg
			// console.log(mw_cfg, &apos;mw_cfg&apos;)
		}
		catch(e)
		{
			console.log(context + &apos;:process_mw_file:middleware loading error:&apos; + e)
			this.error(&apos;process_mw_file:middleware file not found or not valid&apos;)
			
			this.leave_group(&apos;ExecutableRouteMiddleware.exec_http&apos;)
			return undefined
		}

		// PROCESSING MIDDLEWARE
		try {
			this.info(&apos;Processing middleware view&apos;)
			
			const view = mw_cfg.view
			const menubar = mw_cfg.menubar
			const renderer_result_json = this.process_mw_view(view, menubar, arg_credentials)

			this.info(&apos;Loading middleware after&apos;)
			return renderer_result_json
		}
		catch(e)
		{
			console.log(context + &apos;:process_mw_file:middleware processing error:&apos; + e)
			this.error(&apos;process_mw_file:middleware processing error&apos;, e)

			this.leave_group(&apos;ExecutableRouteMiddleware.exec_http&apos;)
			return undefined
		}
	}



	/**
	 * Process a middleware view.
	 * 
	 * @param {string|Component} arg_view_name - middleware view name.
	 * @param {string} arg_menubar_name - middleware menubar name.
	 * @param {Credentials} arg_credentials - request credentials.
	 * 
	 * @returns {object} - JSON rendering result.
	 */
	process_mw_view(arg_view_name, arg_menubar_name, arg_credentials)
	{
		const view_name = T.isString(arg_view_name) ? arg_view_name : ( ( T.isObject(arg_view_name) &amp;&amp; arg_view_name.is_component) ? arg_view_name.get_name() : &apos;undefined&apos;)
		const menubar_name = T.isString(arg_menubar_name) ? arg_menubar_name : ( ( T.isObject(arg_menubar_name) &amp;&amp; arg_menubar_name.is_component) ? arg_menubar_name.get_name() : &apos;undefined&apos;)
		console.log(context + &apos;:process_mw_view:view,menubar:&apos;, view_name, menubar_name)

		assert( T.isString(arg_view_name) || ( T.isObject(arg_view_name) &amp;&amp; arg_view_name.is_component), context + &apos;:process_mw_view:bad view string or object&apos;)

		// GET ASSETS CONFIG
		const assets = this.service.get_assets_services_names(&apos;any&apos;)

		// CREATE RENDERING RESULT AND BUILDER
		const arg_application = undefined
		const renderer = new RenderingBuilder(this.runtime, assets.style, assets.script, assets.image, assets.html, arg_application)
		
		// RENDER TREE
		const renderer_result_json = renderer.render_json_content(arg_view_name, arg_menubar_name, arg_credentials)

		return renderer_result_json
	}



	/**
	 * Populate a response with error message.
	 * 
	 * @param {ServiceResponse} arg_response - response instance.
	 * @param {array} arg_operands      - request operands.
	 * @param {string} arg_error        - error text.
	 * @param {string} arg_target_route - target route (optional).
	 * @param {Error} arg_exception     - exception (optional).
	 * 
	 * @returns {nothing}
	 */
	fill_error(arg_response, arg_operands, arg_error, arg_target_route, arg_exception)
	{
		const op = arg_response.get_operation()
		const svc = arg_response.get_service()
		const error_msg = format(&apos;produce:error=[%s] with svc=[%s] operation=[%s] target route=[%s] exception=[%s].&apos;, arg_error, svc, op, arg_target_route, arg_exception)
		
		arg_response.set_has_error(true)
		arg_response.set_error(error_msg)
		arg_response.set_results(arg_operands)
		
		this.leave_group(error_msg)
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
