<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">js/services/resource/resources_svc_provider.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lucbories/devapt-core-doc" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">default_plugins</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/default_plugins/services_default_plugin.js~DefaultServicesPlugin.html">DefaultServicesPlugin</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">executables</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_command.js~ExecutableCommand.html">ExecutableCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_route.js~ExecutableRoute.html">ExecutableRoute</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/assets</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/assets_svc_provider.js~AssetsSvcProvider.html">AssetsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/executable_route_assets.js~ExecutableRouteAssets.html">ExecutableRouteAssets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/unused_assets_service.js~AssetsService.html">AssetsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/unused_assets_svc_consumer.js~AssetsSvcConsumer.html">AssetsSvcConsumer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/crud</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_service.js~CrudService.html">CrudService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_svc_consumer.js~CrudSvcConsumer.html">CrudSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_svc_provider.js~CrudSvcProvider.html">CrudSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/executable_route_model_crud.js~ExecutableRouteModelCrud.html">ExecutableRouteModelCrud</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/logs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_service.js~LogsService.html">LogsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_svc_consumer.js~LogsSvcConsumer.html">LogsSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/messages</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_service.js~MessagesService.html">MessagesService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_svc_consumer.js~MessagesSvcConsumer.html">MessagesSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_service.js~MetricsBusService.html">MetricsBusService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_svc_consumer.js~MetricsSvcBusConsumer.html">MetricsSvcBusConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_svc_provider.js~MetricsBusSvcProvider.html">MetricsBusSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_host</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_service.js~MetricsHostService.html">MetricsHostService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_svc_consumer.js~MetricsSvcHostConsumer.html">MetricsSvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_svc_provider.js~MetricsHostSvcProvider.html">MetricsHostSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_http</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_service.js~MetricsService.html">MetricsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_svc_consumer.js~MetricsSvcConsumer.html">MetricsSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_svc_provider.js~MetricsSvcProvider.html">MetricsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_nodejs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_service.js~MetricsNodeJsService.html">MetricsNodeJsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_svc_consumer.js~MetricsSvcNodeJsConsumer.html">MetricsSvcNodeJsConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_svc_provider.js~MetricsNodeJsSvcProvider.html">MetricsNodeJsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/middleware</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/executable_route_middleware.js~ExecutableRouteMiddleware.html">ExecutableRouteMiddleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_service.js~MidlewareService.html">MidlewareService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_svc_consumer.js~MiddlewareSvcConsumer.html">MiddlewareSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_svc_provider.js~MiddlewareSvcProvider.html">MiddlewareSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/ping</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/ping/ping_svc_provider.js~PingSvcProvider.html">PingSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/resource</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/executable_route_get_resource.js~ExecutableRouteGetResources.html">ExecutableRouteGetResources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_service.js~ResourcesService.html">ResourcesService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_svc_consumer.js~ResourcesSvcConsumer.html">ResourcesSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_svc_provider.js~ResourcesSvcProvider.html">ResourcesSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/security</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_service.js~SecurityService.html">SecurityService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_consumer.js~SecuritySvcConsumer.html">SecuritySvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_provider.js~SecuritySvcProvider.html">SecuritySvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/topology</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_service.js~TopologyService.html">TopologyService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_consumer.js~TopologySvcHostConsumer.html">TopologySvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/services/resource/resources_svc_provider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
import T from &apos;typr&apos;
import assert from &apos;assert&apos;

// COMMON IMPORTS
import RenderingBuilder from &apos;../../../common/rendering/rendering_builder&apos;

// SERVER IMPORTS
import ExecutableRouteResources from &apos;./executable_route_get_resource&apos;
import ServiceExecProvider from &apos;../base/service_exec_provider&apos;


let context = &apos;server/services/resources/resources_svc_provider&apos;



/**
 * Resources service provider class.
 * 
 * @author Luc BORIES
 * 
 * @license Apache-2.0
 */
export default class ResourcesSvcProvider extends ServiceExecProvider
{
	/**
	 * Create a resources service provider.
	 * 
	 * @param {string} arg_provider_name - consumer name.
	 * @param {Service} arg_service_instance - service instance.
	 * @param {string} arg_context - logging context label.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_provider_name, arg_service_instance, arg_context)
	{
		super(arg_provider_name, arg_service_instance, arg_context ? arg_context : context)
		
		assert(this.service.is_resources_service, context + &apos;:bad resources service&apos;)
		
		this.exec = new ExecutableRouteResources(this)
	}
	
	
	
	/**
	 * Process request and returns datas.
	 * 
	 * @param {string} arg_method - method name.
	 * @param {array} arg_operands - request operands.
	 * @param {object} arg_credentials - request credentials.
	 * 
	 * @returns {Promise}
	 */
	process(arg_method, arg_operands, arg_credentials)
	{
		assert( T.isString(arg_method), context + &apos;:process:bad method string&apos;)
		assert( T.isArray(arg_operands) &amp;&amp; arg_operands.length &gt; 0, context + &apos;:process:bad operands array&apos;)
		assert( T.isObject(arg_credentials) &amp;&amp; arg_credentials.is_credentials, context + &apos;:process:bad credentials object&apos;)
		
		const credentials = arg_credentials.get_credentials()

		const tenant_name = T.isObject(credentials) ? credentials.tenant : undefined
		assert( T.isString(tenant_name) &amp;&amp; tenant_name.length &gt; 0, context + &apos;:process:bad credentials tenant name string&apos;)
		this.debug(&apos;tenant_name&apos;, tenant_name)
		// console.log(&apos;tenant_name&apos;, tenant_name)

		const application_name = T.isObject(credentials) ? credentials.application : undefined
		assert( T.isString(application_name) &amp;&amp; application_name.length &gt; 0, context + &apos;:process:bad credentials application name string&apos;)
		this.debug(&apos;application_name&apos;, application_name)
		// console.log(&apos;application_name&apos;, application_name)
		
		console.log(context + &apos;:process:with method=%s for tenant=%s and app=%s&apos;, arg_method, tenant_name, application_name)

		const defined_tenant = this.get_runtime().defined_world_topology.tenant(tenant_name)
		assert( T.isObject(defined_tenant) &amp;&amp; defined_tenant.is_topology_define_tenant, context + &apos;:process:bad tenant object&apos;)

		const application = defined_tenant.application(application_name)
		assert( T.isObject(application) &amp;&amp; application.is_topology_define_application, context + &apos;:process:bad application object&apos;)

		const args = arg_operands[0]
		assert( T.isObject(args), context + &apos;:process:bad method first operands object&apos;)
		assert( T.isString(args.collection) &amp;&amp; args.collection.length &gt; 0, context + &apos;:process:get:bad collection name string&apos;)
		const collection = args.collection 

		switch(arg_method)
		{
			case &apos;get&apos;: {
				assert( T.isString(args.resource) &amp;&amp; args.resource.length &gt; 0, context + &apos;:process:get:bad resource name string&apos;)
				const resource_name = args.resource
				const type = (collection &amp;&amp; collection != &apos;*&apos;) ? collection : undefined
				
				// DEBUG
				// console.log(&apos;find resource name=%s with type=%s for tenant=%s and app=%s&apos;, resource_name, type, tenant_name, application_name)

				const resource_instance = application.find_resource(resource_name, type)

				if (!  T.isObject(resource_instance) )
				{
					return Promise.reject(&apos;not found&apos;)
				}

				if (collection !== &apos;*&apos; &amp;&amp; (resource_instance.topology_type != collection) )
				{
					return Promise.reject(&apos;found but bad type [&apos; + resource_instance.topology_type + &apos;] for [&apos; + collection + &apos;]&apos;)
				}
				
				return Promise.resolve( this.get_resource_json(resource_instance) )
			}

			case &apos;list&apos;: {
				
				// DEBUG
				// console.log(&apos;list resources of collection=%s for tenant=%s and app=%s&apos;, collection, tenant_name, application_name)
				
				return Promise.resolve( { resources_names:application.get_resources_names(collection) } )
			}

			// case &apos;render&apos;: { // TODO
			// 	if (collection != &apos;views&apos;)
			// 	{
			// 		return Promise.reject(&apos;bad collection, render need views collection&apos;)
			// 	}
			// 	assert( T.isString(args.resource) &amp;&amp; args.resource.length &gt; 0, context + &apos;:process:get:bad resource name string&apos;)
			// 	const resource_name = args.resource
				
			// 	// GET ASSETS CONFIG
			// 	const assets_for_region = this.service.get_assets_services_names(&apos;all&apos;)
			// 	const renderer = new RenderingBuilder(this.runtime, assets_for_region.style, assets_for_region.script, assets_for_region.image, assets_for_region.html)
			// 	const html = renderer.add(resource).render() // TODO
			// 	return Promise.resolve(html)
			// }
		}

		return Promise.reject(&apos;unknow method [&apos; + arg_method + &apos;]&apos;)
	}



	get_resource_json(arg_resource)
	{
		// WRAP INCLUDED FILE
		if ( arg_resource.has_setting(&apos;include_file_path_name&apos;) )
		{
			self.debug(&apos;Process resource.include_file_path_name [%s]&apos;, arg_resource.include_file_path_name)
			
			const file_path = arg_resource.get_setting(&apos;include_file_path_name&apos;)
			if ( T.isString(file_path) )
			{
				try
				{
					const file_content = self.include_file(self, arg_resource, file_path)
					arg_resource.set_setting(&apos;include_file_content&apos;, file_content)
				}
				catch(e)
				{
					const error_msg = &apos;an error occures when loading file [&apos; + e.toString() + &apos;]&apos;
					arg_resource.set_setting(&apos;include_file_content&apos;, error_msg)
					console.error(error_msg)
					return { error:error_msg }
				}
			}
		}
		
		return arg_resource.export_settings()
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
