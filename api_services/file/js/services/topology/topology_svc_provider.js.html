<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">js/services/topology/topology_svc_provider.js | Devapt (Developper Application Toolkit) Core Common</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Common features for Devapt libraries and applications."><meta property="og:type" content="website"><meta property="og:url" content="http://www.devapt.org"><meta property="og:site_name" content="Devapt (Developper Application Toolkit) Core Common"><meta property="og:title" content="Devapt (Developper Application Toolkit) Core Common"><meta property="og:image" content="https://avatars3.githubusercontent.com/u/21240408?v=4&amp;s=200"><meta property="og:description" content="Common features for Devapt libraries and applications."><meta property="og:author" content="https://github.com/lucbories"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Devapt (Developper Application Toolkit) Core Common"><meta property="twitter:description" content="Common features for Devapt libraries and applications."><meta property="twitter:image" content="https://avatars3.githubusercontent.com/u/21240408?v=4&amp;s=200"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/lucbories/devapt-core-common"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#default-plugins">default_plugins</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/default_plugins/services_default_plugin.js~DefaultServicesPlugin.html">DefaultServicesPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#executables">executables</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_command.js~ExecutableCommand.html">ExecutableCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_route.js~ExecutableRoute.html">ExecutableRoute</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-assets">services/assets</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/assets_svc_provider.js~AssetsSvcProvider.html">AssetsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/executable_route_assets.js~ExecutableRouteAssets.html">ExecutableRouteAssets</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-logs">services/logs</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-messages">services/messages</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-metrics">services/metrics</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics/metrics_svc_provider.js~MetricsSvcProvider.html">MetricsSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-middlewares">services/middlewares</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middlewares/executable_route_middleware.js~ExecutableRouteMiddleware.html">ExecutableRouteMiddleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middlewares/middlewares_svc_provider.js~MiddlewaresSvcProvider.html">MiddlewaresSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-ping">services/ping</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/ping/ping_svc_provider.js~PingSvcProvider.html">PingSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-resources">services/resources</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resources/executable_route_get_resource.js~ExecutableRouteGetResources.html">ExecutableRouteGetResources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resources/resources_svc_provider.js~ResourcesSvcProvider.html">ResourcesSvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-security">services/security</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_service.js~SecurityService.html">SecurityService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_consumer.js~SecuritySvcConsumer.html">SecuritySvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_provider.js~SecuritySvcProvider.html">SecuritySvcProvider</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-todo-crud">services/todo_crud</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/crud_service.js~CrudService.html">CrudService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/crud_svc_consumer.js~CrudSvcConsumer.html">CrudSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/crud_svc_provider.js~CrudSvcProvider.html">CrudSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/todo_crud/executable_route_model_crud.js~ExecutableRouteModelCrud.html">ExecutableRouteModelCrud</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services-topology">services/topology</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_service.js~TopologyService.html">TopologyService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_consumer.js~TopologySvcHostConsumer.html">TopologySvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/services/topology/topology_svc_provider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
import assert from &apos;assert&apos;

// COMMON IMPORTS
import T               from &apos;devapt-core-common/dist/js/utils/types&apos;
import ServiceProvider from &apos;devapt-core-common/dist/js/services/service_provider&apos;
import ServiceResponse from &apos;devapt-core-common/dist/js/services/service_response&apos;

// SERVICES IMPORTS


/**
 * Contextual constant for this file logs.
 * @private
 */
const context = &apos;services/topology/topology_svc_provider&apos;

/**
 * Operation name.
 * @private
 */
const GET_TENANTS_NAMES =&apos;devapt-deployed-tenants-names&apos;
/**
 * Operation name.
 * @private
 */
const GET_TENANTS_INFOS =&apos;devapt-deployed-tenants-infos&apos;
/**
 * Operation name.
 * @private
 */
const GET_TENANT_INFOS = &apos;devapt-deployed-tenant-infos&apos;

/**
 * Operation name.
 * @private
 */
const GET_TENANT_APPLICATIONS_NAMES = &apos;devapt-deployed-applications-names&apos;
/**
 * Operation name.
 * @private
 */
const GET_TENANT_APPLICATIONS_INFOS = &apos;devapt-deployed-applications-infos&apos;
/**
 * Operation name.
 * @private
 */
const GET_TENANT_APPLICATION_INFOS = &apos;devapt-deployed-application-infos&apos;

/**
 * Operation name.
 * @private
 */
const GET_TENANT_SERVICES_NAMES = &apos;devapt-deployed-services-names&apos;
/**
 * Operation name.
 * @private
 */
const GET_TENANT_SERVICES_INFOS = &apos;devapt-deployed-services-infos&apos;
/**
 * Operation name.
 * @private
 */
const GET_TENANT_SERVICE_INFOS = &apos;devapt-deployed-service-infos&apos;

/**
 * Operation name.
 * @private
 */
const GET_NODES_NAMES = &apos;devapt-deployed-nodes&apos;



/**
 * Topology service provider class.
 * @author Luc BORIES
 * @license Apache-2.0
 */
export default class TopologySvcProvider extends ServiceProvider
{
	/**
	 * Create a topology service provider.
	 * 
	 * @param {string} arg_provider_name - consumer name.
	 * @param {Service} arg_service_instance - service instance.
	 * @param {string} arg_context - logging context label.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_provider_name, arg_service_instance, arg_context=context)
	{
		super(arg_provider_name, arg_service_instance, arg_context)

		/**
		 * Class test flag.
		 * @type {boolean}
		 */
		this.is_topology_svc_provider = true
	}



	/**
	 * Get provider operations names.
	 * 
	 * @returns {array} - operations names.
	 */
	get_operations_names()
	{
		return [
			GET_TENANTS_NAMES, GET_TENANTS_INFOS, GET_TENANT_INFOS,
			GET_TENANT_APPLICATIONS_NAMES, GET_TENANT_APPLICATIONS_INFOS, GET_TENANT_APPLICATION_INFOS,
			GET_TENANT_SERVICES_NAMES, GET_TENANT_SERVICES_INFOS, GET_TENANT_SERVICE_INFOS,
			GET_NODES_NAMES
		]
		//.concat(super.get_operations_names())
	}


	
	/**
	 * Produce service datas on request.
	 * 
	 * @param {ServiceRequest} arg_request - service request instance.
	 * 
	 * @returns {Promise} - promise of ServiceResponse instance.
	 */
	produce(arg_request)
	{
		this.enter_group(&apos;produce&apos;)

		if ( ! T.isObject(arg_request) || ! arg_request.is_service_request)
		{
			this.leave_group(&apos;produce:error:bad request object&apos;)
			return Promise.resolve({error:&apos;bad request object&apos;})
		}

		const operation = arg_request.get_operation()
		console.log(context + &apos;:produce:request for service=&apos; + this.service.get_name() + &apos;:operation=&apos; + operation, &apos;operands=&apos;, arg_request.get_operands())

		const deployed_topology = this.get_runtime().get_deployed_topology()
		const operand_0 = arg_request.get_operand(0)
		const operand_1 = arg_request.get_operand(1)
		const tenant_name = T.isNotEmptyString(operand_0) ? operand_0 : undefined
		const item_name = T.isNotEmptyString(operand_1) ? operand_1 : undefined

		console.log(context + &apos;:produce:request for service=[%s] operation=[%s] tenant=[%s] item=[%s]&apos;, this.service.get_name(), operation, tenant_name, item_name)
		const response = new ServiceResponse(arg_request)
		let results = []
		switch(operation){
			case GET_TENANTS_NAMES:
				results = deployed_topology.get_deployed_tenants_names()
				break
			case GET_TENANTS_INFOS:
				results = deployed_topology.get_deployed_tenants_infos(true)
				break
			case GET_TENANT_INFOS:
				results = tenant_name ? deployed_topology.get_deployed_tenant_infos(tenant_name, true) : []
				break
			
			case GET_TENANT_APPLICATIONS_NAMES:
				results = tenant_name ? deployed_topology.get_deployed_tenant_applications_names(tenant_name) : []
				break
			case GET_TENANT_APPLICATIONS_INFOS:
				results = tenant_name ? deployed_topology.get_deployed_tenant_applications_infos(tenant_name, true) : []
				break
			case GET_TENANT_APPLICATION_INFOS:
				results = tenant_name &amp;&amp; item_name ? deployed_topology.get_deployed_tenant_application_infos(tenant_name, item_name, true) : []
				break
			
			case GET_TENANT_SERVICES_NAMES:
				results = tenant_name ? deployed_topology.get_deployed_tenant_services_names(tenant_name) : []
				break
			case GET_TENANT_SERVICES_INFOS:
				results = tenant_name ? deployed_topology.get_deployed_tenant_services_infos(tenant_name, true) : []
				break
			case GET_TENANT_SERVICE_INFOS:
				results = tenant_name &amp;&amp; item_name ? deployed_topology.get_deployed_tenant_service_infos(tenant_name, item_name, true) : []
				break

			case GET_NODES_NAMES:
				results = deployed_topology.get_deployed_nodes_names()
				break

			default:
				response.set_has_error(true)
				response.set_error(&apos;produce:error:bad operation [&apos; + operation + &apos;]&apos;)
				
				this.leave_group(&apos;produce:error:bad operation [&apos; + operation + &apos;]&apos;)
				return Promise.resolve(response)
		}
		if (! results)
		{
			response.set_has_error(true)
			response.set_error(&apos;produce:error:operation failure [&apos; + operation + &apos;], check tenant_name=&apos; + tenant_name + &apos; or item name=&apos; + item_name)

			this.leave_group(&apos;produce:error:operation failure [&apos; + operation + &apos;], check tenant_name=&apos; + tenant_name + &apos; or item name=&apos; + item_name)
			return Promise.resolve(response)

			// this.leave_group(&apos;produce:super.&apos;)
			// return super.produce(arg_request)
		}
		response.set_results(results)

		// console.log(context + &apos;:produce:reply for service=&apos; + this.service.get_name() + &apos;:operation=&apos; + operation, response.get_properties_values())
		
		this.leave_group(&apos;produce&apos;)
		return Promise.resolve(response)
	}


	/**
	 * Get deployed nodes.
	 * 
	 * @returns {array}
	 */
	get_deployed_nodes_topology()
	{
		let topology = { nodes:{} }

		// LOOP ON DEFINED NODES
		const nodes = this.get_runtime().get_defined_topology().nodes().get_latest_items()
		assert( T.isArray(nodes), context + &apos;:get_deployed_nodes_topology:bad runtime.nodes array&apos;)
		nodes.forEach(
			(node) =&gt; {
				topology.nodes[node.get_name()] = this.get_deployed_node_topology(node)
			}
		)

		return topology.nodes
	}



	/**
	 * Get deployed topology for a node.
	 * 
	 * @param {TopologyDeployedNode} arg_deployed_node - deployed node.
	 * 
	 * @returns {object} - deployed node topology plain object.
	 */
	get_deployed_node_topology(arg_deployed_node)
	{
		const node_topology = {
			name:arg_deployed_node.get_name(),
			servers:{}
		}

		// LOOP ON NODE SERVERS
		const node_servers = arg_deployed_node.servers().get_latest_items()
		assert( T.isArray(node_servers), context + &apos;:get_deployed_node_topology:bad node.servers array&apos;)
		node_servers.forEach(
			(server) =&gt; {
				node_topology.servers[server.get_name()] = this.get_deployed_server(server)
			}
		)
		
		return node_topology
	}



	/**
	 * Get deployed topology for a server.
	 * 
	 * @param {TopologyDeployedServer} arg_deployed_server - deployed server.
	 * 
	 * @returns {object} - deployed server topology plain object.
	 */
	get_deployed_server_topology(arg_deployed_server)
	{
		const server_topology = {
			host:arg_deployed_server.server_host,
			port:arg_deployed_server.server_port,
			protocole:arg_deployed_server.server_protocole,
			type:arg_deployed_server.server_type,
			middlewares:arg_deployed_server.server_middlewares,
			use_socketio:arg_deployed_server.server_use_socketio
		}
		
		return server_topology
	}



	/**
	 * Get deployed tenants topology.
	 * 
	 * @returns {object} - deployed tenants topology plain object.
	 */
	get_deployed_tenants_topology()
	{
		const tenants_topology = {
		}
		
		return tenants_topology
	}



	/**
	 * Get deployed tenants topology.
	 * 
	 * @returns {object} - deployed tenant topology plain object.
	 */
	get_deployed_tenant_topology(arg_tenant_name)
	{
		const tenant_topology = {
		}
		
		return tenant_topology
	}



	/**
	 * Get deployed tenants topology.
	 * 
	 * @returns {object} - deployed tenant topology plain object.
	 */
	get_deployed_application_topology(arg_tenant_name)
	{
		const tenant_topology = {
		}
		
		return tenant_topology
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
