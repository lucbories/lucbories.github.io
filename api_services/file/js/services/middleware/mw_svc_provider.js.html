<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">js/services/middleware/mw_svc_provider.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lucbories/devapt-core-doc" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">default_plugins</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/default_plugins/services_default_plugin.js~DefaultServicesPlugin.html">DefaultServicesPlugin</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">executables</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_command.js~ExecutableCommand.html">ExecutableCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_route.js~ExecutableRoute.html">ExecutableRoute</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/assets</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/assets_svc_provider.js~AssetsSvcProvider.html">AssetsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/executable_route_assets.js~ExecutableRouteAssets.html">ExecutableRouteAssets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/unused_assets_service.js~AssetsService.html">AssetsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/unused_assets_svc_consumer.js~AssetsSvcConsumer.html">AssetsSvcConsumer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/crud</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_service.js~CrudService.html">CrudService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_svc_consumer.js~CrudSvcConsumer.html">CrudSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_svc_provider.js~CrudSvcProvider.html">CrudSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/executable_route_model_crud.js~ExecutableRouteModelCrud.html">ExecutableRouteModelCrud</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/logs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_service.js~LogsService.html">LogsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_svc_consumer.js~LogsSvcConsumer.html">LogsSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/messages</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_service.js~MessagesService.html">MessagesService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_svc_consumer.js~MessagesSvcConsumer.html">MessagesSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_service.js~MetricsBusService.html">MetricsBusService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_svc_consumer.js~MetricsSvcBusConsumer.html">MetricsSvcBusConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_svc_provider.js~MetricsBusSvcProvider.html">MetricsBusSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_host</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_service.js~MetricsHostService.html">MetricsHostService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_svc_consumer.js~MetricsSvcHostConsumer.html">MetricsSvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_svc_provider.js~MetricsHostSvcProvider.html">MetricsHostSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_http</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_service.js~MetricsService.html">MetricsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_svc_consumer.js~MetricsSvcConsumer.html">MetricsSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_svc_provider.js~MetricsSvcProvider.html">MetricsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_nodejs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_service.js~MetricsNodeJsService.html">MetricsNodeJsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_svc_consumer.js~MetricsSvcNodeJsConsumer.html">MetricsSvcNodeJsConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_svc_provider.js~MetricsNodeJsSvcProvider.html">MetricsNodeJsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/middleware</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/executable_route_middleware.js~ExecutableRouteMiddleware.html">ExecutableRouteMiddleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_service.js~MidlewareService.html">MidlewareService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_svc_consumer.js~MiddlewareSvcConsumer.html">MiddlewareSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_svc_provider.js~MiddlewareSvcProvider.html">MiddlewareSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/ping</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/ping/ping_svc_provider.js~PingSvcProvider.html">PingSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/resource</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/executable_route_get_resource.js~ExecutableRouteGetResources.html">ExecutableRouteGetResources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_service.js~ResourcesService.html">ResourcesService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_svc_consumer.js~ResourcesSvcConsumer.html">ResourcesSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_svc_provider.js~ResourcesSvcProvider.html">ResourcesSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/security</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_service.js~SecurityService.html">SecurityService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_consumer.js~SecuritySvcConsumer.html">SecuritySvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_provider.js~SecuritySvcProvider.html">SecuritySvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/topology</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_service.js~TopologyService.html">TopologyService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_consumer.js~TopologySvcHostConsumer.html">TopologySvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/services/middleware/mw_svc_provider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
import T from &apos;typr&apos;
import assert from &apos;assert&apos;

// COMMON IMPORTS
// import RenderingResult  from &apos;../../../common/rendering/rendering_result&apos;
import RenderingBuilder from &apos;../../../common/rendering/rendering_builder&apos;

// SERVER IMPORTS
import ExecutableRouteMiddleware from &apos;./executable_route_middleware&apos;
import ServiceExecProvider from &apos;../base/service_exec_provider&apos;


let context = &apos;server/services/middleware/mw_svc_provider&apos;



/**
 * Middleware service provider class.
 * @author Luc BORIES
 * @license Apache-2.0
 */
export default class MiddlewareSvcProvider extends ServiceExecProvider
{
	/**
	 * Create a middleware service provider.
	 * 
	 * @param {string} arg_provider_name - consumer name.
	 * @param {Service} arg_service_instance - service instance.
	 * @param {string} arg_context - logging context label.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_provider_name, arg_service_instance, arg_context)
	{
		super(arg_provider_name, arg_service_instance, arg_context ? arg_context : context)
		
		assert(this.service.is_mw_service, context + &apos;:bad mw service&apos;)
		
		this.exec = new ExecutableRouteMiddleware()
		this.exec.service = this.service
	}
	
	
	
	/**
	 * Process request and returns datas.
	 * 
	 * @param {string} arg_method - method name.
	 * @param {array} arg_operands - request operands.
	 * @param {Credentials} arg_credentials - request credentials.
	 * 
	 * @returns {Promise}
	 */
	process(arg_method, arg_operands, arg_credentials)
	{
		console.log(context + &apos;:process:method, operands:&apos;, arg_method, arg_operands)

		assert( T.isString(arg_method), context + &apos;:process:bad method string&apos;)
		assert( T.isArray(arg_operands), context + &apos;:process:bad operands array&apos;)
		assert( T.isObject(arg_credentials) &amp;&amp; arg_credentials.is_credentials, context + &apos;:process:bad credentials object&apos;)
		
		const method = arg_method.toLocaleLowerCase()
		let target_route = arg_operands[0].route
		target_route = target_route.endsWith(&apos;/&apos;) ? target_route.slice(0, target_route.length - 1) : target_route
		const routes = this.get_setting_js(&apos;routes&apos;)
		console.log(context + &apos;:process:target_route:&apos;, target_route)

		switch(method) {
			case &apos;get&apos;: {
				let rendering_result = undefined

				// SEARCH ROUTE
				let route_mw_file = undefined
				let route_page_view = undefined
				let route_page_menubar = undefined

				// TODO REPLACE FOREACH TO END LOOP ON FOUND
				routes.forEach(
					(route_cfg)=&gt;{
						const loop_route = route_cfg.route.endsWith(&apos;/&apos;) ? route_cfg.route.slice(0, target_route.length - 1) : route_cfg.route
						if (loop_route == target_route)
						{
							route_mw_file = route_cfg.mw_file
							route_page_view = route_cfg.page_view
							route_page_menubar = route_cfg.page_menubar

							console.log(context + &apos;:process:target_route found&apos;)
						}
					}
				)

				try {
					// PROCESS MIDDLEWARE FILE
					if ( T.isString(route_mw_file) )
					{
						console.log(context + &apos;:process:route_mw_file found&apos;, route_mw_file)

						rendering_result = this.process_mw_file(route_mw_file, arg_credentials)

						return Promise.resolve(rendering_result)
					}

					// VIEW RENDERING MIDDLEWARE
					if ( T.isString(route_page_view) )
					{
						console.log(context + &apos;:process:route_page_view found&apos;, route_page_view)

						rendering_result = this.process_mw_view(route_page_view, route_page_menubar, arg_credentials)

						return Promise.resolve(rendering_result)
					}

					// BAD ROUTE CONFIG
					return Promise.reject(context + &apos;:process:route not found for target [&apos; + target_route + &apos;]&apos;)
				}
				catch(e)
				{
					console.error(context + &apos;:process:exception=&apos;, e)
					return Promise.reject(context + &apos;:process:exception=&apos; + e)
				}
			}
		}

		return Promise.reject(context + &apos;:process:bad config&apos;)
	}



	/**
	 * Process a middleware file.
	 * 
	 * @param {string} arg_mw_file - middleware file.
	 * @param {Credentials} arg_credentials - request credentials.
	 * 
	 * @returns {RenderingResult}
	 */
	process_mw_file(arg_mw_file, arg_credentials)
	{
		this.info(&apos;process_mw_file:file:&apos;, arg_mw_file)
		assert( T.isString(arg_mw_file), context + &apos;:process_mw_file:bad file string&apos;)
		
		let mw_cfg = undefined

		// CHECK PATH
		const path_file_name = this.get_runtime().context.get_absolute_path(arg_mw_file)
		assert(T.isString(path_file_name), context + &apos;:bad middleware file path string&apos;)
		
		// LOAD MIDDLEWARE FILE
		try {
			this.info(&apos;Loading middleware file&apos;)
			
			mw_cfg = require(path_file_name).service_cfg
			// console.log(mw_cfg, &apos;mw_cfg&apos;)
		}
		catch(e)
		{
			console.log(context + &apos;:process_mw_file:middleware loading error:&apos; + e)
			this.error(&apos;process_mw_file:middleware file not found or not valid&apos;)
			
			this.leave_group(&apos;ExecutableRouteMiddleware.exec_http&apos;)
			return undefined
		}

		// PROCESSING MIDDLEWARE
		try {
			this.info(&apos;Processing middleware view&apos;)
			
			const view = mw_cfg.view
			const menubar = mw_cfg.menubar
			const result = this.process_mw_view(view, menubar, arg_credentials)

			this.info(&apos;Loading middleware after&apos;)
			return result
		}
		catch(e)
		{
			console.log(context + &apos;:process_mw_file:middleware processing error:&apos; + e)
			this.error(&apos;process_mw_file:middleware processing error&apos;, e)

			this.leave_group(&apos;ExecutableRouteMiddleware.exec_http&apos;)
			return undefined
		}
	}



	/**
	 * Process a middleware view.
	 * 
	 * @param {string|Component} arg_view_name - middleware view name.
	 * @param {string} arg_menubar_name - middleware menubar name.
	 * @param {Credentials} arg_credentials - request credentials.
	 * 
	 * @returns {RenderingResult}
	 */
	process_mw_view(arg_view_name, arg_menubar_name, arg_credentials)
	{
		const view_name = T.isString(arg_view_name) ? arg_view_name : ( ( T.isObject(arg_view_name) &amp;&amp; arg_view_name.is_component) ? arg_view_name.get_name() : &apos;undefined&apos;)
		const menubar_name = T.isString(arg_menubar_name) ? arg_menubar_name : ( ( T.isObject(arg_menubar_name) &amp;&amp; arg_menubar_name.is_component) ? arg_menubar_name.get_name() : &apos;undefined&apos;)
		console.log(context + &apos;:process_mw_view:view,menubar:&apos;, view_name, menubar_name)

		assert( T.isString(arg_view_name) || ( T.isObject(arg_view_name) &amp;&amp; arg_view_name.is_component), context + &apos;:process_mw_view:bad view string or object&apos;)

		// GET ASSETS CONFIG
		const assets = this.service.get_assets_services_names(&apos;any&apos;)

		// CREATE RENDERING RESULT AND BUILDER
		const arg_application = undefined
		const renderer = new RenderingBuilder(this.runtime, assets.style, assets.script, assets.image, assets.html, arg_application)
		
		// RENDER TREE
		const renderer_result = renderer.render_json_content(arg_view_name, arg_menubar_name, arg_credentials)

		return renderer_result
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
