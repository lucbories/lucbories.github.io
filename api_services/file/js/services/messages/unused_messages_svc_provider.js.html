<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">js/services/messages/unused_messages_svc_provider.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lucbories/devapt-core-doc" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">default_plugins</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/default_plugins/services_default_plugin.js~DefaultServicesPlugin.html">DefaultServicesPlugin</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">executables</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_command.js~ExecutableCommand.html">ExecutableCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/executables/executable_route.js~ExecutableRoute.html">ExecutableRoute</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/assets</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/assets_svc_provider.js~AssetsSvcProvider.html">AssetsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/executable_route_assets.js~ExecutableRouteAssets.html">ExecutableRouteAssets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/unused_assets_service.js~AssetsService.html">AssetsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/assets/unused_assets_svc_consumer.js~AssetsSvcConsumer.html">AssetsSvcConsumer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/crud</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_service.js~CrudService.html">CrudService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_svc_consumer.js~CrudSvcConsumer.html">CrudSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/crud_svc_provider.js~CrudSvcProvider.html">CrudSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/crud/executable_route_model_crud.js~ExecutableRouteModelCrud.html">ExecutableRouteModelCrud</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/logs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_service.js~LogsService.html">LogsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_svc_consumer.js~LogsSvcConsumer.html">LogsSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/logs/unused_logs_svc_provider.js~LogsSvcProvider.html">LogsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/messages</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_service.js~MessagesService.html">MessagesService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_svc_consumer.js~MessagesSvcConsumer.html">MessagesSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/messages/unused_messages_svc_provider.js~MessagesSvcProvider.html">MessagesSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_service.js~MetricsBusService.html">MetricsBusService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_svc_consumer.js~MetricsSvcBusConsumer.html">MetricsSvcBusConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_bus/metrics_svc_provider.js~MetricsBusSvcProvider.html">MetricsBusSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_host</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_service.js~MetricsHostService.html">MetricsHostService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_svc_consumer.js~MetricsSvcHostConsumer.html">MetricsSvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_host/metrics_svc_provider.js~MetricsHostSvcProvider.html">MetricsHostSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_http</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_service.js~MetricsService.html">MetricsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_svc_consumer.js~MetricsSvcConsumer.html">MetricsSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_http/metrics_svc_provider.js~MetricsSvcProvider.html">MetricsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/metrics_nodejs</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_service.js~MetricsNodeJsService.html">MetricsNodeJsService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_svc_consumer.js~MetricsSvcNodeJsConsumer.html">MetricsSvcNodeJsConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/metrics_nodejs/metrics_svc_provider.js~MetricsNodeJsSvcProvider.html">MetricsNodeJsSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/middleware</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/executable_route_middleware.js~ExecutableRouteMiddleware.html">ExecutableRouteMiddleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_service.js~MidlewareService.html">MidlewareService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_svc_consumer.js~MiddlewareSvcConsumer.html">MiddlewareSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/middleware/mw_svc_provider.js~MiddlewareSvcProvider.html">MiddlewareSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/ping</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/ping/ping_svc_provider.js~PingSvcProvider.html">PingSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/resource</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/executable_route_get_resource.js~ExecutableRouteGetResources.html">ExecutableRouteGetResources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_service.js~ResourcesService.html">ResourcesService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_svc_consumer.js~ResourcesSvcConsumer.html">ResourcesSvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/resource/resources_svc_provider.js~ResourcesSvcProvider.html">ResourcesSvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/security</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_service.js~SecurityService.html">SecurityService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_consumer.js~SecuritySvcConsumer.html">SecuritySvcConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/security/security_svc_provider.js~SecuritySvcProvider.html">SecuritySvcProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services/topology</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_service.js~TopologyService.html">TopologyService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_consumer.js~TopologySvcHostConsumer.html">TopologySvcHostConsumer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/services/topology/unused_topology_svc_provider.js~TopologySvcProvider.html">TopologySvcProvider</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/services/messages/unused_messages_svc_provider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
import T from &apos;typr&apos;
import assert from &apos;assert&apos;

// COMMON IMPORTS
import Stream from &apos;../../../common/messaging/stream&apos;

import runtime from &apos;../../base/runtime&apos;
// SERVER IMPORTS
import SocketIOServiceProvider from &apos;../base/socketio_service_provider&apos;


let context = &apos;server/services/messages/messages_svc_provider&apos;



/**
 * Messages service provider class.
 * @author Luc BORIES
 * @license Apache-2.0
 */
export default class MessagesSvcProvider extends SocketIOServiceProvider
{
	/**
	 * Create a Messages service provider.
	 * 
	 * @param {string} arg_provider_name - consumer name.
	 * @param {Service} arg_service_instance - service instance.
	 * @param {string} arg_context - logging context label.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_provider_name, arg_service_instance, arg_context)
	{
		super(arg_provider_name, arg_service_instance, arg_context ? arg_context : context)
		
		assert(this.service.is_messages_service, context + &apos;:constructor:bad Messages service&apos;)
		
		this.is_messages_service_provider = true
		

		// INIT STREAM TRANSFORMATION WHEN BUS IS READY
		this.is_ready = false
		const self = this
		runtime.node.msg_bus_feature.started_promise.then(
			() =&gt; {
				// console.log(context + &apos;:init:msg feature is ready&apos;)

				const bus = runtime.node.get_msg_bus()
				const gws = bus.get_gateways()
				if ( gws.length &gt; 0)
				{
					// LOOP ON BUS GATEWAYS
					let gws_promises = []
					gws.forEach(
						(gw) =&gt; {
							// console.log(context + &apos;:init:msg feature gw=%s&apos;, gw.get_name())
							gws_promises.push(gw.started_promise)
						}
					)
					Promise.all(gws_promises).then( self.init_messages_bus_stream.bind(self) )
				}
				else
				{
					self.init_messages_bus_stream()
				}
			}
		)


		// DEBUG
		// this.messages_bus_stream.subscribe(
		// 	(messages_record) =&gt; {
		// 		console.log(context + &apos;:messages_bus_stream.subscribe:&apos;, messages_record)
		// 	}
		// )
	}


	
	
	init_messages_bus_stream()
	{
		const self = this
		// console.log(context + &apos;:init_messages_bus_stream&apos;)

		// CREATE NEW STREAM OF MESSAGES WITH TRANSPORTER ATTRIBUTE
		const bus = runtime.node.get_msg_bus()
		this.messages_bus_stream = new Stream()
		const bus_stream_with_transporter = bus.get_output_stream().get_transformed_stream().map(
			(msg) =&gt; {
				msg.transporter = bus.get_name()
				return msg
			}
		)
		this.messages_bus_stream.set_transformed_stream(bus_stream_with_transporter)

		// LOOP ON BUS GATEWAYS
		const gws = bus.get_gateways()
		if ( gws.length &gt; 0)
		{
			let merged_stream = bus_stream_with_transporter
			gws.forEach(
				(gw) =&gt; {
					// console.log(context + &apos;:init:merge gw stream=%s&apos;, gw.get_name())
					const stream = gw.get_output_stream()
					if (stream)
					{
						const gw_stream_with_transporter = stream.get_transformed_stream().map(
							(msg) =&gt; {
								msg.transporter = gw.get_name()
								// console.log(context + &apos;:gw bus msg:transporter=%s sender=%s target=%s&apos;, msg.transporter, msg.sender, msg.target)
								return msg
							}
						)
						merged_stream = merged_stream.merge(gw_stream_with_transporter)
					}
				}
			)
			this.messages_bus_stream.set_transformed_stream(merged_stream)
		}

		const msg_cb = (arg_msg) =&gt; {
			const message_ts = new Date()
			const message_transporter = arg_msg &amp;&amp; arg_msg.transporter ? arg_msg.transporter : &apos;unknow&apos;
			const message_sender = arg_msg &amp;&amp; arg_msg.sender ? arg_msg.sender : &apos;unknow&apos;
			const message_target = arg_msg &amp;&amp; arg_msg.target ? arg_msg.target : &apos;unknow&apos;
			const message_payload = arg_msg &amp;&amp; arg_msg.payload ? arg_msg.payload : { error:&apos;unknow message payload&apos; }
			
			const max_payload_chars = 100
			let payload_str = JSON.stringify( message_payload )
			payload_str = payload_str.substr(0, max_payload_chars)
			// payload_str = escape(payload_str) // TODO SANITIZE

			const message_record = {
				ts:message_ts,
				transporter:message_transporter,
				sender:message_sender,
				target:message_target,
				payload:payload_str
			}
			
			// console.log(context + &apos;:init_messages_bus_stream::msg_cb:message_record&apos;, message_record)

			return [message_record]
		}
		
		self.messages_bus_stream_transfomed = self.messages_bus_stream.get_transformed_stream().map(msg_cb)
		
		self.messages_bus_stream_transfomed.onValue(
			(values) =&gt; {
				const msg = values[0]
				// console.log(context + &apos;:provided_values_stream.push:transporter=%s sender=%s target=%s&apos;, msg.transporter, msg.sender, msg.target)

				this.provided_values_stream.push(values)
			}
		)

		this.is_ready = true
	}
	
	
	
	/**
	 * Process request and returns datas.
	 * 
	 * @param {string} arg_method - method name.
	 * @param {array} arg_operands - request operands.
	 * @param {Credentials} arg_credentials - request credentials.
	 * 
	 * @returns {Promise}
	 */
	process(arg_method, arg_operands, arg_credentials)
	{
		// console.log(context + &apos;:process&apos;)
		assert(this.is_ready, context + &apos;:process:not ready yet&apos;)
		assert( T.isString(arg_method), context + &apos;:process:bad method string&apos;)
		assert( T.isArray(arg_operands), context + &apos;:process:bad operands array&apos;)
		assert( T.isObject(arg_credentials) &amp;&amp; arg_credentials.is_credentials, context + &apos;:process:bad credentials object&apos;)
		
		switch(arg_method)
		{
			case &apos;get&apos;: {
				// GET WITHOUT OPERANDS
				if ( arg_operands.length == 0)
				{
					const bus_state_values = {}
					// console.log(bus_state_values, context + &apos;:produce:get:no opds:bus_state_values&apos;)
					
					return Promise.resolve(bus_state_values)
				}
				
				// GET WITH OPERANDS
				const first_operand = arg_operands[0]
				
				if ( T.isObject(first_operand) &amp;&amp; T.isObject(first_operand.args) )
				{
					if ( T.isString(first_operand.args.bus_name) )
					{
						const bus_state_values = {}
						// console.log(bus_state_values, context + &apos;:produce:get:bus_name=&apos; + first_operand.args.bus_name + &apos;:bus_state_values&apos;)
						
						return Promise.resolve(bus_state_values)
					}
				}
				
				const bus_state_values = {}
				// console.log(bus_state_values, context + &apos;:produce:get:bad opds:bus_state_values&apos;)
				return Promise.resolve(bus_state_values)
			}
			
			case &apos;list&apos;: {
				const bus_state_items = {}
				// console.log(bus_state_items, context + &apos;:produce:list:bus_state_items&apos;)
				
				return Promise.resolve(bus_state_items)
			}
		}
		
		
		return Promise.reject(&apos;bad data request operation [&apos; + arg_method + &apos;]&apos;)
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
