<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Documentation Index</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="./api/styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="./api/styles/site.cerulean.css">

</head>


<body>


<div class="navbar navbar-default navbar-fixed-top ">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="index.html">Devapt Doc</a>
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <div class="navbar-collapse collapse" id="topNavigation">
            <ul class="nav navbar-nav">
                <li><a href="README.html">Readme</a></li>
                <li><a href="GETTING_STARTED.html">Getting started</a></li>
                <li><a href="INSTALL.html">Install</a></li>
                <li><a href="api/index.html" target="_blank">API</a></li>

				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown">Features<b class="caret"></b></a>
					<ul class="dropdown-menu inline">
						<li><a href="CONFIGURABLE.html">Configurable</a></li>
						<li><a href="DISTRIBUTED.html">Distributed</a></li>
						<li><a href="MESSAGING.html">Messaging</a></li>
						<li><a href="METRICS.html">Metrics</a></li>
						<li><a href="RENDERING.html">Rendering</a></li>
						<li><a href="SECURITY.html">Security</a></li>
						<li><a href="SERVERS.html">Servers</a></li>
						<li><a href="SERVICES.html">Services</a></li>
					</ul>
				</li>
				
                <li><a href="ROADMAP.html">Roadmap</a></li>
                <li><a href="CONTRIBUTING.html">Contributing</a></li>
            </ul>
        </div>
    </div>
</div>


<div class="container" id="toc-content">
	<div class="row">
		<div class="col-md-8">
			<div id="main"><h1 id="devaptruntimestartingprocess">Devapt runtime starting process</h1>

<h2 id="startingcode">Starting code</h2>

<pre><code class="js">var devapt = require('devapt/base/runtime'); // for ES5
import runtime from 'devapt/base/runtime' // for ES6 / ES2015

var runtime_settings = {
    'is_master':true,
    'name':'NodeA',

    // BUSES SERVERS (for inter nodex communication)
    "master":{
        "name":"NodeA",

        "msg_bus":{
            "type":"simplebus_server",
            "host":"localhost",
            "port":5000
        },
        "logs_bus":{
            "type":"simplebus_server",
            "host":"localhost",
            "port":5001
        },
        "metrics_bus":{
            "type":"simplebus_server",
            "host":"localhost",
            "port":5002
        }
    },

    "base_dir": "",

    "settings_provider": {
        "source":"local_file",
        "relative_path":"resources/apps.json"
    }
}

runtime.load(runtime_settings)
</code></pre>

<hr />

<h2 id="startingsequencebrief">Starting sequence brief</h2>

<h3 id="importruntimefromdevaptbaseruntime">import runtime from 'devapt/base/runtime'</h3>

<p>The first time the file is loaded, the singleton instance of Runtime class is created.</p>

<p>Runtime.constructor is called to define instance attributes:</p>

<pre><code class="js">this.is_runtime = true
this.is_master = this.get_setting('is_master', false)

this.node = null

this.nodes = new Collection()
this.servers = new Collection()
this.services = new Collection()
this.registered_services = new Collection()

this.modules = new Collection()
this.plugins = new Collection()
this.resources = new Collection()

this.transactions = new Collection()
this.applications = new Collection()

this.security = new Security()
</code></pre>

<p>Security.constructor
* call AuthenticationManager.constructor
* call AuthorizationManager.constructor</p>

<h3 id="runtimeload">runtime.load</h3>

<p>Load method register runtime settings and call a sequence of executable instances.
* RuntimeStage0Executable
* RuntimeStage1Executable
* RuntimeStage2Executable
* RuntimeStage3Executable
* RuntimeStage4Executable
* RuntimeStage5Executable</p>

<hr />

<h2 id="startingsequencedetails">Starting sequence details</h2>

<h3 id="runtimeloadingstage0runtimestage0executable">Runtime loading stage 0 - RuntimeStage0Executable</h3>

<ul>
<li>create and load runtime node</li>
<li>create bus instance or connect to an existing bus</li>
</ul>

<p>Example of code</p>

<pre><code class="js">this.runtime.node = new Node(node_name, this.runtime.get_settings())
this.runtime.node.load()
</code></pre>

<p>Node.constructor
* init Node.servers collection</p>

<p>Node.load (for a master node)
* create and load a bus server and connect to it
* create and load a metrics server and connect to it</p>

<p>Node.load (not for a master node)
* connect to an existing bus server
* connect to an existing metrics server</p>

<h3 id="runtimeloadingstage1runtimestage1executable">Runtime loading stage 1 - RuntimeStage1Executable</h3>

<ul>
<li>load master apps settings</li>
<li>load security settings</li>
<li>load loggers settings</li>
</ul>

<p>dispatch<em>store</em>config<em>set</em>all(settings) for master node only</p>

<p>runtime.security.load = Security.load
* call this.authentication<em>manager.load(authentication settings)
* call this.authorization</em>manager.load(authorization settings)</p>

<p>AuthenticationManager.load
* select one of AuthenticationPlugin* (AuthenticationPluginPassportLocalDb, AuthenticationPluginPassportLocalFile)
* call AuthenticationPlugin<em>.constructor
* call AuthenticationPlugin</em>.enable(plugin settings)
!!! AuthenticationPluginPassportLocalDb needs users Model which is defined in stage 3</p>

<h3 id="runtimeloadingstage2runtimestage2executable">Runtime loading stage 2 - RuntimeStage2Executable</h3>

<ul>
<li>create node servers (for master node only)</li>
<li>create services (for master node only)</li>
</ul>

<pre><code class="js">runtime.node.load_master_settings(node_settings)
make_services()
</code></pre>

<p>Node.load<em>master</em>settings
call Node.load<em>servers
for each servers settings call Node.create</em>server</p>

<pre><code class="js">let server = this.create_server(server_type, server_name, server_cfg)
server.load()
server.node = this
server.init_bus_client(host, port)
this.servers.add(server)
</code></pre>

<p>Node.create_server
create a Server instance (ExpressServer, RestifyServer...)</p>

<p>Server.load
load server settings
call Server.build_server</p>

<p>Server.build_server
build a Server.server instance as an Express or Restify object for example.
load server middlewares for errors, security, metrics...</p>

<p>make_services
for each service config of node settings services
* create a Service instance
* call service.enable()
* call runtime.services.add(service)</p>

<h3 id="runtimeloadingstage3runtimestage3executable">Runtime loading stage 3 - RuntimeStage3Executable</h3>

<ul>
<li>create Database instances (connexions), call db.load, call runtime.resources.add(db)</li>
<li>create Module instances, call module.load, call runtime.modules.add(module)</li>
<li>loop on modules resources and call runtime.resources.add(res_obj) for each one</li>
<li>for each model resources call resource.load<em>associations() and resource.load</em>includes()</li>
<li>create Plugin instances, call plugin.load, call runtime.plugins.add(plugin)</li>
</ul>

<p>Module.load
loop on resources settings and create Resource instances (Model, View, Menu, Menubar, Database)</p>

<h3 id="runtimeloadingstage4runtimestage4executable">Runtime loading stage 4 - RuntimeStage4Executable</h3>

<p>If node is master
* create Application instances from runtime settings
* call application.load
* call runtime.applications.add(application)</p>

<p>Application.load
* enable consumed services
* enable used services
* enable used plugins
* enable provided services</p>

<h3 id="runtimeloadingstage5runtimestage5executable">Runtime loading stage 5 - RuntimeStage5Executable</h3>

<ul>
<li>enable servers (for master node only)</li>
</ul>

<p>if node is master node, call runtime.node.start()</p>

<p>runtime.node.start
call server.enable() on each runtime servers</p>

<p>Server.enable
apply security middlewares !!! TODO
start listening</p>
			</div>
		</div>
	</div>
</div>


<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>


<footer>
	<p style="text-align:center;">...</p>
	<span class="jsdoc-message">
		GitHub Repos: <a href="https://github.com/lucbories/devapt">Devapt</a>
		
		 - <a href="https://github.com/lucbories/devapt-devtools">Devtools</a>

		 - <a href="https://github.com/lucbories/devapt-app-devtools">Devtools application</a>

		 - <a href="https://github.com/lucbories">All devapt relative repositories (plugins, apps)</a>
		
		 - <a href="https://www.npmjs.com/search?q=devapt">Devapt npm packages</a>.
	</span>
	<p style="text-align:center;">...</p>
</footer>


<script src="./api/scripts/docstrap.lib.js"></script>
<script src="./api/scripts/toc.js"></script>
<script type="text/javascript" src="./api/scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>


</body>
</html>