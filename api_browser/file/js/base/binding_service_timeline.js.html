<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">js/base/binding_service_timeline.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lucbories/devapt-core-doc" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">base</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding_service.js~BindingService.html">BindingService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding_service_timeline.js~BindingServiceTimeline.html">BindingServiceTimeline</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding_stream.js~BindingStream.html">BindingStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/bindings_loader.js~BindingLoader.html">BindingLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/container.js~Container.html">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/dom.js~Dom.html">Dom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/layout.js~Layout.html">Layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/layout_simple.js~LayoutSimple.html">LayoutSimple</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/name_type_settings_loggable.js~NameTypeSettingsLoggable.html">NameTypeSettingsLoggable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/rendering.js~Rendering.html">Rendering</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">commands</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/commands/command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/commands/display_command.js~DisplayCommand.html">DisplayCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/attributes_table.js~AttributesTable.html">AttributesTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/dock.js~Dock.html">Dock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/input-field.js~InputField.html">InputField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/logs_table.js~LogsTable.html">LogsTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/page.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/records_table.js~RecordsTable.html">RecordsTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/table.js~Table.html">Table</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/table_tree.js~TableTree.html">TableTree</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/tabs.js~Tabs.html">Tabs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/topology.js~Topology.html">Topology</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/tree.js~Tree.html">Tree</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">loggers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/loggers/console_logger.js~ConsoleLogger.html">ConsoleLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/loggers/stream_logger.js~StreamLogger.html">StreamLogger</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/client_runtime.js~ClientRuntime.html">ClientRuntime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/router_state.js~RouterState.html">RouterState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/service.js~Service.html">Service</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/service_operation.js~ServiceOperation.html">ServiceOperation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui.js~UI.html">UI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui_factory.js~UIFactory.html">UIFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui_rendering.js~UIRendering.html">UIRendering</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/base/binding_service_timeline.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
import assert from &apos;assert&apos;
import { format } from &apos;util&apos;

// COMMON IMPORTS
import T             from &apos;../../../node_modules/devapt-core-common/dist/js/utils/types&apos;
import { transform } from &apos;../../../node_modules/devapt-core-common/dist/js/utils/transform&apos;
import Stream        from &apos;../../../node_modules/devapt-core-common/dist/js/messaging/stream&apos;

// BROWSER IMPORTS
import BindingStream from &apos;./binding_stream&apos;


const context = &apos;browser/base/binding_service_timeline&apos;



/**
 * @file UI binding class for service based timeline.
 * 
 * @author Luc BORIES
 * 
 * @license Apache-2.0
 */
export default class BindingServiceTimeline extends BindingStream
{
	/**
	 * Creates an instance of Binding.
	 * @extends Bindable
	 *
	 * @param {string} arg_id - binding identifier.
	 * @param {RuntimeBase} arg_runtime - client runtime.
	 * @param {Component} arg_component - component instance.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_id, arg_runtime, arg_component)
	{
		super(arg_id, arg_runtime, arg_component)

		this.is_binding_service_timeline = true
	}

	
	/**
	 * Build binding.
	 * 
	 * @returns {Promise} 
	 */
	build()
	{
		this._component.enter_group(&apos;build&apos;)

		console.info(context + &apos;:build:loading binding for component &apos; + this._component.get_name(), this._stream)
		
		assert( T.isString(this._source_timeline),       context + format(&apos;:build:component=%s:bad timeline name=%s&apos;,            this._component.get_name(), this._source_timeline) )
		assert( T.isString(this._source_svc_name),       context + format(&apos;:build:component=%s:bad service name=%s,timeline=%s&apos;, this._component.get_name(), this._source_timeline, this._source_svc_name) )
		assert( T.isString(this._source_svc_method),     context + format(&apos;:build:component=%s:bad service name=%s,timeline=%s&apos;, this._component.get_name(), this._source_timeline, this._source_svc_method) )
		assert( T.isArray(this._targets) &amp;&amp; this._targets.length &gt; 0, context + format(&apos;:build:component=%s,timeline=%s:bad targets&apos;,  this._component.get_name(), this._source_timeline, this._source_svc_method) )
		assert( T.isString(this._target_method),         context + format(&apos;:build:component=%s,timeline=%s:bad target method=%s&apos;, this._component.get_name(), this._source_timeline, this._target_method) )
		
		let promise = this.bind_timeline()
		promise = promise.then(
			(unsubscribe)=&gt;{
				this._unsubscribe = unsubscribe

				if ( T.isArray(this._state_path) &amp;&amp; this._state_path.length &gt; 0 )
				{
					const opds = { method:{ operands:[this._state_path]}}
					this.set_targets_instances_array([this._component])
					this.set_target_method_name(&apos;dispatch_update_state_value_action&apos;)
					this.set_options(opds)
					return this.bind_timeline().then(
						(unsubscribe)=&gt;{
							this._unsubscribe_state_update = unsubscribe
						}
					)
				}
			}
		)
		
		this._component.leave_group(&apos;build:async&apos;)
		return promise
	}
	
	
	
	/**
	 * Bind a service timeline stream event on object method.
	 * 
	 * @returns {Promise}
	 */
	bind_timeline()
	{
		// console.info(context + &apos;:bind_timeline:loading binding for component &apos; + this._component.get_name(), this._source_timeline)
		
		return this._runtime.register_service(this._source_svc_name).then(
			(svc) =&gt; {
				// console.log(context + &apos;:bind_timeline:svc&apos;, svc)
				assert( (this._source_svc_method in svc) &amp;&amp; T.isFunction(svc[this._source_svc_method]), context + &apos;:bind_timeline:bad bound method function&apos;)
				
				if (this._source_svc_method == &apos;post&apos;)
				{
					svc.subscribe() // TODO ???????
				}
				
				const method_cfg = T.isObject(this._options) ? this._options.method : undefined
				const operands   = T.isObject(method_cfg) ? method_cfg.operands : undefined
				const format_cfg = T.isObject(this._options) ? this._options.format  : undefined

				assert( this._source_timeline in svc[this._source_svc_method].timelines, context + &apos;:bind_timeline:timeline name [&apos; + this._source_timeline + &apos;] not found&apos;)
				assert( T.isObject( svc[this._source_svc_method].timelines[this._source_timeline] ), context + &apos;:bind_timeline:bad timeline object&apos;)
				
				const stream = svc[this._source_svc_method].timelines[this._source_timeline].stream
				// stream.subscribe( (datas) =&gt; {console.log(context + &apos;:bind_timeline:timeline=%s datas=&apos;, arg_timeline_name, datas) } )
				
				const unsubscribes = []
				this._targets.forEach(
					(target, index)=&gt;{
						// const method = this._target_method
						// console.info(context + &apos;:bind_timeline:component=%s timeline=%s target at %s method=%s&apos;, this._component.get_name(), this._source_timeline, index, method)
						
						const values_xform = {
							&quot;result_type&quot;:&quot;single&quot;,
							&quot;fields&quot;:[
								{
									&quot;name&quot;:&apos;value at &apos; + index,
									&quot;path&quot;:&apos;value&apos;
								}
							]
						}
						
						const datas_xform = (arg_stream_record) =&gt; {
							if (arg_stream_record.datas)
							{
								// console.log(context + &apos;:bind_stream:datas&apos;, arg_stream_record.datas)
								return arg_stream_record.datas
							}
							return arg_stream_record
						}

						let extracted_stream = stream.map(datas_xform).map( transform(values_xform) )
						if (this._options &amp;&amp; T.isBoolean(this._options.dispatch) &amp;&amp; this._options.dispatch)
						{
							const at_index_xform = (arg_stream_record) =&gt; {
								if ( T.isArray(arg_stream_record) &amp;&amp; arg_stream_record.length &gt; index )
								{
									return arg_stream_record[index]
								}
								return undefined
							}

							extracted_stream = extracted_stream.map(at_index_xform)
						}

						// INIT STARTING VALUE
						this._stream = new Stream( extracted_stream.startWith(this._starting_value) )
						
						// DEBUG
						// this._stream.get_source_stream().onValue(
						// 	(extracted_value) =&gt; {
						// 		console.log(context + &apos;:bind_timeline:timeline=%s method=%s stream value=&apos;, this._source_timeline, method, extracted_value)
						// 	}
						// )

						const unbind = this.bind_stream(this._stream, this._source_xform, target, this._target_method, operands, format_cfg, this._starting_value)
						unsubscribes.push(unbind)

						// if ( T.isArray(this._state_path) &amp;&amp; this._state_path.length &gt; 0 )
						// {
						// 	const opds = { method:{ operands:[this._state_path]}}
						// 	this._unsubscribe_state_update = this.bind_stream(this._stream, this._source_xform, [this._component], &apos;dispatch_update_state_value_action&apos;, opds)
						// }
					}
				)

				return ()=&gt;{
					unsubscribes.forEach(
						(unsubscribe)=&gt;{
							unsubscribe()
						}
					)
				}
			}
		)
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
