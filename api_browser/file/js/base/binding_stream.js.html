<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">js/base/binding_stream.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lucbories/devapt-core-doc" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">base</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding_service.js~BindingService.html">BindingService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding_service_timeline.js~BindingServiceTimeline.html">BindingServiceTimeline</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding_stream.js~BindingStream.html">BindingStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/bindings_loader.js~BindingLoader.html">BindingLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/container.js~Container.html">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/dom.js~Dom.html">Dom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/layout.js~Layout.html">Layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/layout_simple.js~LayoutSimple.html">LayoutSimple</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/name_type_settings_loggable.js~NameTypeSettingsLoggable.html">NameTypeSettingsLoggable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/rendering.js~Rendering.html">Rendering</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">commands</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/commands/command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/commands/display_command.js~DisplayCommand.html">DisplayCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/attributes_table.js~AttributesTable.html">AttributesTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/dock.js~Dock.html">Dock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/input-field.js~InputField.html">InputField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/logs_table.js~LogsTable.html">LogsTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/page.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/records_table.js~RecordsTable.html">RecordsTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/table.js~Table.html">Table</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/table_tree.js~TableTree.html">TableTree</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/tabs.js~Tabs.html">Tabs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/topology.js~Topology.html">Topology</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/tree.js~Tree.html">Tree</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">loggers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/loggers/console_logger.js~ConsoleLogger.html">ConsoleLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/loggers/stream_logger.js~StreamLogger.html">StreamLogger</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">runtime</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/client_runtime.js~ClientRuntime.html">ClientRuntime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/router_state.js~RouterState.html">RouterState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/service.js~Service.html">Service</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/service_operation.js~ServiceOperation.html">ServiceOperation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui.js~UI.html">UI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui_factory.js~UIFactory.html">UIFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui_rendering.js~UIRendering.html">UIRendering</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/base/binding_stream.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
import assert from &apos;assert&apos;
import { format } from &apos;util&apos;

// COMMON IMPORTS
import T             from &apos;../../../node_modules/devapt-core-common/dist/js/utils/types&apos;
import uid           from &apos;../../../node_modules/devapt-core-common/dist/js/utils/uid.js&apos;
import { transform } from &apos;../../../node_modules/devapt-core-common/dist/js/utils/transform&apos;


const context = &apos;browser/base/binding_stream&apos;



/**
 * @file UI component binding class.
 * 
 * @author Luc BORIES
 * 
 * @license Apache-2.0
 */
export default class BindingStream
{
	/**
	 * Creates an instance of Binding for stream.
	 *
	 * @param {string} arg_id - binding identifier.
	 * @param {RuntimeBase} arg_runtime - client runtime.
	 * @param {Component} arg_component - component instance.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_id, arg_runtime, arg_component)
	{
		this.is_binding_stream = true

		this._id = arg_id ? arg_id : &apos;binding_&apos; + uid()
		this._runtime = arg_runtime
		this._component = arg_component

		this._unsubscribe = undefined
		this._unsubscribe_state_update = undefined

		this._stream = undefined
		this._state_path = undefined
		this._starting_value = undefined
		this._source_svc_name = undefined
		this._source_svc_method = undefined
		this._source_xform = undefined
		this._source_timeline = undefined
		this._targets = undefined
		this._target_method = undefined
		this._options = undefined
	}


	
	set_stream(arg_stream)
	{
		this._stream = arg_stream
		return this
	}
	
	set_state_path(arg_state_path)
	{
		this._state_path = arg_state_path
		return this
	}
	
	set_starting_value(arg_starting_value)
	{
		this._starting_value = arg_starting_value
		return this
	}

	set_source_service_name(arg_source_svc_name)
	{
		this._source_svc_name = arg_source_svc_name
		return this
	}

	set_source_service_method(arg_source_svc_method)
	{
		this._source_svc_method = arg_source_svc_method
		return this
	}

	set_source_transformation(arg_transformation)
	{
		this._source_xform = arg_transformation
		return this
	}

	set_source_timeline_name(arg_source_timeline)
	{
		this._source_timeline = arg_source_timeline
		return this
	}

	set_targets_instances_array(arg_targets)
	{
		this._targets = arg_targets
		return this
	}

	set_target_method_name(arg_target_method)
	{
		this._target_method = arg_target_method
		return this
	}

	set_options(arg_options)
	{
		this._options = arg_options
		return this
	}
	

	
	/**
	 * Build binding.
	 * 
	 * @returns {Promise} 
	 */
	build()
	{
		console.info(context + &apos;:build:loading binding for component &apos; + this._component.get_name(), this._target_method, this._stream)
		
		this._component.enter_group(&apos;build&apos;)

		// CHECK ATTRIBUTES
		if ( T.isArray(this._stream) )
		{
			this._stream.forEach(
				(stream, index)=&gt;{
					assert( T.isObject(stream) &amp;&amp; stream.is_stream, context + format(&apos;:build:component=%s:bad stream object at index=%s&apos;, this._component.get_name(), index) )
				}
			)
		} else {
			assert( T.isObject(this._stream) &amp;&amp; this._stream.is_stream, context + format(&apos;:build:component=%s:bad stream object&apos;, this._component.get_name()) )
		}
		assert( T.isArray(this._targets) &amp;&amp; this._targets.length &gt; 0, context + format(&apos;:build:component=%s,timeline=%s:bad targets&apos;,            this._component.get_name(), this._source_timeline, this._source_svc_method) )
		assert( T.isString(this._target_method) || T.isNotEmptyArray(this._target_method), context + format(&apos;:build:component=%s,timeline=%s:bad target method=%s&apos;,   this._component.get_name(), this._source_timeline, this._target_method) )
		
		const method_cfg = T.isObject(this._options) ? this._options.method  : undefined
		const operands   = T.isObject(method_cfg)    ? method_cfg.operands   : undefined
		const format_cfg = T.isObject(this._options) ? this._options.format  : undefined
		
		const unsubscribes = []
		this._targets.forEach(
			(target, index)=&gt;{
				const stream = T.isArray(this._stream) ? (this._stream.length &gt; index ? this._stream[index] : this._stream[this._stream.length - 1]) : this._stream
				
				let unbind = undefined
				if ( T.isString(this._target_method) )
				{
					// console.info(context + &apos;:build:loading binding for component &apos; + this._component.get_name() + &apos; with method=&apos; + this._target_method)
					
					unbind = this.bind_stream(stream, this._source_xform, target, this._target_method, operands, format_cfg, this._starting_value)
					unsubscribes.push(unbind)
				}
				else if ( T.isNotEmptyArray(this._target_method) )
				{
					this._target_method.forEach(
						(method_name)=&gt;{
							if ( T.isString(method_name) )
							{
								// console.info(context + &apos;:build:loading binding for component &apos; + this._component.get_name() + &apos; with methods=&apos; + method_name)
								
								unbind = this.bind_stream(stream, this._source_xform, target, method_name, operands, format_cfg, this._starting_value)
								unsubscribes.push(unbind)
							}
						}
					)
				}
			}
		)

		this._unsubscribe =  ()=&gt;{
			unsubscribes.forEach(
				(unsubscribe)=&gt;{
					unsubscribe()
				}
			)
		}

		if ( T.isArray(this._state_path) &amp;&amp; this._state_path.length &gt; 0 )
		{
			const stream = T.isArray(this._stream) ? this._stream[0] : this._stream
			if (! T.isObject(stream) || ! stream.is_stream)
			{
				console.warn(context + &apos;:build:bad state path stream for component %s&apos;, this._component.get_name(), this._stream, stream)
				return
			}
			this._unsubscribe_state_update = this.bind_stream(stream, this._source_xform, this._component, &apos;dispatch_update_state_value_action&apos;, [this._state_path])
		}

		this._component.leave_group(&apos;build:async&apos;)
		return Promise.resolve()
	}
	
	
	
	/**
	 * Bind a stream to a target object action.
	 * 
	 * @param {object}    arg_stream           - stream instance.
	 * @param {string|array|function} arg_values_xform - values transformation (optional).
	 * @param {object}    arg_bound_object     - target object instance (optional: this as default).
	 * @param {string}    arg_bound_method     - target object method string.
	 * @param {anything}  arg_method_operands  - target object method operands (optional).
	 * @param {object}    arg_format_object    - formatting settings.
	 * @param {any}       arg_starting_value   - starting value.
	 * @param {object}    arg_options          - binding options.
	 * 
	 * @returns {function} - unsubscribe function.
	 */
	bind_stream(arg_stream, arg_values_xform, arg_bound_object, arg_bound_method, arg_method_operands, arg_format_object, arg_starting_value, arg_options)
	{
		// console.info(context + &apos;:bind_stream:loading binding for component &apos; + this._component.get_name(), arg_bound_method, arg_method_operands, this._stream, arg_bound_object, this._source_timeline)

		let unbind_cb = undefined

		// SET TARGET OBJECT
		arg_bound_object = arg_bound_object ? arg_bound_object : this._component
		if ( T.isString(arg_bound_object) )
		{
			if ( T.isUndefined(arg_bound_method) )
			{
				arg_bound_method = arg_bound_object
				arg_bound_object = this._component
			} else if (arg_bound_object == &apos;this&apos;)
			{
				arg_bound_object = this._component
			}
			else
			{
				console.error(context + &apos;:bind_stream:bad bound object string:%s&apos;, arg_bound_object)
				return undefined
			}
		}

		// TODO: DO NOT USE TYPR TO TEST DOM ELEMENTS
		// TYPR USE toString FUNCTION TO TEST TYPE against [object Object].
		// FOR OBJECT, toString give [object Object]
		// BUT DOM ELEMENTS toString GIVE [object HTMLXXXElement]
		assert( T.isObject(arg_stream) &amp;&amp; arg_stream.is_stream, context + &apos;:bind_stream:bad stream object&apos;)
		assert( T.isObject(arg_bound_object) || typeof arg_bound_object == &apos;object&apos;, context + &apos;:bind_stream:bad bound object&apos;)
		assert( T.isString(arg_bound_method), context + &apos;:bind_stream:bad bound method string&apos;)
		
		// CHECK OBJECT METHOD
		if ( ! (arg_bound_method in arg_bound_object) )
		{
			console.error(context + &apos;:bind_stream:bad method [%s] for bound object=&apos;, arg_bound_method, arg_bound_object)
			return undefined
		}

		// DEBUG
		arg_stream.get_transformed_stream().onValue(
			(values) =&gt; {
				console.log(context + &apos;:bind_stream:on initial stream:%s:bound method=%s, bound object, values&apos;, this._component.get_name(), arg_bound_method, arg_bound_object, values)
			}
		)

		// SET FORMATTING FUNCTION
		let formatting_xform = undefined
		if ( T.isObject(arg_format_object) &amp;&amp; T.isString(arg_format_object.type) )
		{
			formatting_xform = this.get_format_value_function(arg_format_object)
		}

		// SET XFORM FOR SIMPLE SETTINGS
		if ( T.isString(arg_values_xform) )
		{
			const field_name = arg_values_xform
			arg_values_xform = {
				&quot;result_type&quot;:&quot;single&quot;,
				&quot;fields&quot;:[
					{
						&quot;name&quot;:field_name,
						&quot;path&quot;:field_name
					}
				]
			}
		}

		if ( T.isUndefined(arg_values_xform) || arg_values_xform == null )
		{
			let xform_stream = T.isFunction(formatting_xform) ? arg_stream.get_transformed_stream().map(formatting_xform) : arg_stream.get_transformed_stream()

			if ( ! T.isUndefined(arg_starting_value) )
			{
				xform_stream = xform_stream.startWith(arg_starting_value)
			}

			if (arg_method_operands)
			{
				if ( T.isArray(arg_method_operands) )
				{
					// console.log(context + &apos;:bind_stream:set a stream handler for method=%s with array operands=&apos;, arg_bound_method, arg_method_operands)
					unbind_cb = xform_stream.toProperty().assign(arg_bound_object, arg_bound_method, ...arg_method_operands)
				}
				else
				{ 
					// console.log(context + &apos;:bind_stream:set a stream handler for method=%s with not array operands=&apos;, arg_bound_method, arg_method_operands)
					unbind_cb = xform_stream.toProperty().assign(arg_bound_object, arg_bound_method, arg_method_operands)
				}
			}
			else
			{
				unbind_cb = xform_stream.toProperty().assign(arg_bound_object, arg_bound_method)
			}
		}
		
		else if ( T.isFunction(arg_values_xform) )
		{
			let xform_stream = arg_stream.get_transformed_stream().map(arg_values_xform)
			xform_stream = T.isFunction(formatting_xform) ? xform_stream.map(formatting_xform) : xform_stream

			if ( ! T.isUndefined(arg_starting_value) )
			{
				xform_stream = xform_stream.startWith(arg_starting_value)
			}
			
			if (arg_method_operands)
			{
				unbind_cb = xform_stream.toProperty().assign(arg_bound_object, arg_bound_method, ...arg_method_operands)
			}
			else
			{
				unbind_cb = xform_stream.map(arg_values_xform).toProperty().assign(arg_bound_object, arg_bound_method)
			}
		}

		else if ( T.isObject(arg_values_xform) )
		{
			const datas_xform = (arg_stream_record) =&gt; {
				if (arg_stream_record.datas)
				{
					return arg_stream_record.datas
				}
				return arg_stream_record
			}

			let xform_stream = arg_stream.get_transformed_stream().map(datas_xform).map( transform(arg_values_xform) )
			
			// DEBUG
			// xform_stream.map(datas_xform).map( transform(arg_values_xform) ).onValue(
			// 	(values) =&gt; {
			// 		console.log(context + &apos;:bind_stream:%s:on values_xform stream:bound method=%s, bound object, values&apos;, name, arg_bound_method, arg_bound_object, values)
			// 	}
			// )

			xform_stream = T.isFunction(formatting_xform) ? xform_stream.map(formatting_xform) : xform_stream
			
			if ( ! T.isUndefined(arg_starting_value) )
			{
				xform_stream = xform_stream.startWith(arg_starting_value)
			}

			if (arg_options &amp;&amp; T.isBoolean(arg_options.dispatch) &amp;&amp; arg_options.dispatch &amp;&amp; T.isNumber(arg_options.index) &amp;&amp; arg_options.index &gt; 0 )
			{
				const at_index_xform = (arg_stream_record) =&gt; {
					if ( T.isArray(arg_stream_record) &amp;&amp; arg_stream_record.length &gt; arg_options.index )
					{
						return arg_stream_record[arg_options.index]
					}
					return undefined
				}

				xform_stream = xform_stream.map(at_index_xform)
			}

			// DEBUG
			// xform_stream.onValue(
			// 	(values) =&gt; {
			// 		console.log(context + &apos;:bind_stream:on transformed stream:%s:bound method=%s, bound object, values&apos;, name, arg_bound_method, arg_bound_object, values)
			// 	}
			// )
			if (this._runtime.shoud_log_bindingd_stream())
			{
				const target = arg_bound_object &amp;&amp; arg_bound_object.get_name ? arg_bound_object.get_name() : (arg_bound_object &amp;&amp; arg_bound_object.attr ? arg_bound_object.attr(&apos;id&apos;) : (arg_bound_object &amp;&amp; arg_bound_object.getAtttribute ? arg_bound_object.getAttribute(&apos;id&apos;) : &apos;unknow&apos;))
				xform_stream.onValue(
					(values) =&gt; {
						const datas = T.isArray(values) ? &apos;array of length &apos; + values.length : (T.isObject(values) ? &apos;object of keys &apos; + Object.keys(values).toString() : &apos;datas&apos;)
						this._component.debug(&apos;bind_stream:on transformed stream:%s:target=%s,method=%s:values&apos;, name, target, arg_bound_method, datas)
					}
				)
			}

			if (arg_method_operands)
			{
				if ( T.isArray(arg_method_operands) )
				{
					unbind_cb = xform_stream.onValue(arg_bound_object, arg_bound_method, ...arg_method_operands)
				} else {
					unbind_cb = xform_stream.onValue(arg_bound_object, arg_bound_method, arg_method_operands)
				}
			}
			else
			{
				unbind_cb = xform_stream.onValue(arg_bound_object, arg_bound_method)
			}
		}
		else
		{
			assert(false, context + &apos;:bind_svc:bad values paths string|array|function&apos;)
		}

		return unbind_cb
	}
	
	
	
	/**
	 * Get a formatting function or identity.
	 * Format settings example:
	 * 		{
	 * 			&quot;type&quot;:&quot;number&quot;,
	 * 			&quot;digits&quot;:2
	 * 		}
	 * 
	 * @param {object} arg_format_object - format settings.
	 * 
	 * @returns {Function} - Formatting function or identity.
	 */
	get_format_value_function(arg_format_object)
	{
		if (! T.isObject(arg_format_object) || ! T.isString(arg_format_object.type) )
		{
			return (x) =&gt; x
		}

		switch(arg_format_object.type.toLocaleLowerCase()) {
			case &apos;number&apos;: {
				if ( T.isNumber(arg_format_object.digits) )
				{
					return (x) =&gt; {
						if (T.isNumber(x))
						{
							return x.toFixed(arg_format_object.digits)
						}
						return undefined
					}
				}
				return (x) =&gt; (T.isNumber(x) ? x : undefined)
			}
		}

		return (x) =&gt; x
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
