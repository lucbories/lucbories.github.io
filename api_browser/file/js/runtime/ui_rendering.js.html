<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">js/runtime/ui_rendering.js | Devapt (Developper Application Toolkit) Core Common</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Common features for Devapt libraries and applications."><meta property="og:type" content="website"><meta property="og:url" content="http://www.devapt.org"><meta property="og:site_name" content="Devapt (Developper Application Toolkit) Core Common"><meta property="og:title" content="Devapt (Developper Application Toolkit) Core Common"><meta property="og:image" content="https://avatars3.githubusercontent.com/u/21240408?v=4&amp;s=200"><meta property="og:description" content="Common features for Devapt libraries and applications."><meta property="og:author" content="https://github.com/lucbories"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Devapt (Developper Application Toolkit) Core Common"><meta property="twitter:description" content="Common features for Devapt libraries and applications."><meta property="twitter:image" content="https://avatars3.githubusercontent.com/u/21240408?v=4&amp;s=200"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/lucbories/devapt-core-common"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#base">base</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/container.js~Container.html">Container</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/feature.js~Feature.html">Feature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/name_type_settings_loggable.js~NameTypeSettingsLoggable.html">NameTypeSettingsLoggable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/web_worker.js~WebWorker.html">WebWorker</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#base-binding">base/binding</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding/binding_service.js~BindingService.html">BindingService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding/binding_service_timeline.js~BindingServiceTimeline.html">BindingServiceTimeline</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding/binding_stream.js~BindingStream.html">BindingStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/binding/bindings_loader.js~BindingLoader.html">BindingLoader</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#base-component">base/component</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component/bound_dom.js~BoundDom.html">BoundDom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component/dom.js~Dom.html">Dom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component/rendered_dom.js~RenderedDDom.html">RenderedDDom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component/rendering.js~Rendering.html">Rendering</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component/stated_dom.js~StatedDom.html">StatedDom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/component/unused_component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#base-layout">base/layout</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/layout/layout.js~Layout.html">Layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/layout/layout_simple.js~LayoutSimple.html">LayoutSimple</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#commands">commands</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/commands/command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/commands/display_command.js~DisplayCommand.html">DisplayCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/commands/worker_command.js~WorkerCommand.html">WorkerCommand</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components">components</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/attributes_table.js~AttributesTable.html">AttributesTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/dock.js~Dock.html">Dock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/dock_item.js~DockItem.html">DockItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/input-field.js~InputField.html">InputField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/logs_table.js~LogsTable.html">LogsTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/page.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/records_table.js~RecordsTable.html">RecordsTable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/table.js~Table.html">Table</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/table_tree.js~TableTree.html">TableTree</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/tabs.js~Tabs.html">Tabs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/topology.js~Topology.html">Topology</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/components/tree.js~Tree.html">Tree</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#loggers">loggers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/loggers/console_logger.js~ConsoleLogger.html">ConsoleLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/loggers/stream_logger.js~StreamLogger.html">StreamLogger</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#runtime">runtime</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/client_runtime.js~ClientRuntime.html">ClientRuntime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/router_state.js~RouterState.html">RouterState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/service.js~Service.html">Service</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/service_operation.js~ServiceOperation.html">ServiceOperation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui.js~UI.html">UI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui_factory.js~UIFactory.html">UIFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/runtime/ui_rendering.js~UIRendering.html">UIRendering</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/runtime/ui_rendering.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// NPM IMPORTS
// import assert from &apos;assert&apos;
// import _ from &apos;lodash&apos;
// import vdom_as_json from &apos;vdom-as-json&apos;
// const vdom_from_json = vdom_as_json.fromJson
// import VNode from &apos;virtual-dom/vnode/vnode&apos;

// COMMON IMPORTS
import T             from &apos;../../../node_modules/devapt-core-common/dist/js/utils/types&apos;
import html_entities from &apos;../../../node_modules/devapt-core-common/dist/js/utils/html_entities&apos;
import Loggable      from &apos;../../../node_modules/devapt-core-common/dist/js/base/loggable&apos;

// BROWSER IMPORTS


const context = &apos;browser/runtime/ui_rendering&apos;



/**
 * @file UI rendering class.
 * @author Luc BORIES
 * @license Apache-2.0
 */
export default class UIRendering extends Loggable
{
	/**
	 * Create a UI rendering instance.
	 * 
	 * 	API:
	 * 		-&gt;constructor(arg_runtime, arg_ui)
	 * 
	 * 		-&gt;process_assets_urls_templates(arg_assets_urls_templates)
	 * 		-&gt;process_rendering_result_headers(arg_rendering_result_headers=[], arg_credentials)
	 * 
	 * 		-&gt;get_asset_url(arg_url, arg_type, arg_credentials=undefined)
	 * 
	 * 		-&gt;create_dom_url_element(arg_dom_element, arg_tag, arg_id, arg_url, arg_type)
	 * 
	 * 		-&gt;process_rendering_result_scripts_urls(arg_dom_element, arg_rendering_result_scripts_urls=[], arg_credentials)
	 * 		-&gt;process_rendering_result_scripts_tags(arg_dom_element, arg_rendering_result_scripts_tags=[], arg_credentials)
	 * 		-&gt;process_rendering_result_styles_urls(arg_dom_element, arg_rendering_result_styles_urls=[], arg_credentials)
	 * 		-&gt;process_rendering_result_styles_tags(arg_dom_element, arg_rendering_result_styles_tags=[], arg_credentials)
	 * 
	 * @param {object} arg_runtime - client runtime.
	 * @param {object} arg_store - UI components state store.
	 * 
	 * @returns {nothing}
	 */
	constructor(arg_runtime, arg_ui)
	{
		super(context, arg_runtime.get_logger_manager())

		this.is_ui_rendering = true

		this._runtime = arg_runtime
		this._ui = arg_ui

		this._content_id = &apos;content&apos;
		this._content_element = undefined
		
		let assets_urls_templates = this._ui.store.get_state().get(&apos;assets_urls_templates&apos;, undefined)
		assets_urls_templates = assets_urls_templates ? assets_urls_templates.toJS() : undefined
		
		this.process_assets_urls_templates(assets_urls_templates)

		// this.enable_trace()
		// this.update_trace_enabled()
	}
	
	// TODO API DOC FOR process_assets_urls_templates(arg_assets_urls_templates)
	process_assets_urls_templates(arg_assets_urls_templates)
	{
		if (arg_assets_urls_templates)
		{
			this._assets_urls_templates = {
				script: html_entities.decode( arg_assets_urls_templates.script ),
				style:  html_entities.decode( arg_assets_urls_templates.style ),
				image:  html_entities.decode( arg_assets_urls_templates.image ),
				html:   html_entities.decode( arg_assets_urls_templates.html )
			}
		}
	}

	// TODO API DOC FOR process_rendering_result_headers(arg_rendering_result_headers=[]/*, arg_credentials*/)
	process_rendering_result_headers(arg_rendering_result_headers=[]/*, arg_credentials*/)
	{
		this.debug(&apos;process_rendering_result_headers:rendering headers&apos;, arg_rendering_result_headers)
		
		// TODO

		// arg_rendering_result_headers.forEach(
		// 	(header)=&gt;{
		// 		const has_header = false // TODO
		// 		// const e = document.createElement(header)
		// 		// document.head.appendChild(e)// TODO
		// 	}
		// )
	}

	// TODO API DOC FOR get_asset_url(arg_url, arg_type, arg_credentials=undefined)
	get_asset_url(arg_url, arg_type, arg_credentials=undefined)
	{
		const template = this._assets_urls_templates[arg_type]
		const url = T.isString(template) ? template.replace(&apos;{{url}}&apos;, arg_url) : arg_url
		const credentials_tag = &apos;{{credentials_url}}&apos;

		this.debug(&apos;get_asset_url:url&apos;, arg_url)
		this.debug(&apos;get_asset_url:type&apos;, arg_type)
		this.debug(&apos;get_asset_url:template&apos;, template)
		this.debug(&apos;get_asset_url:url&apos;, url)
		
		if ( url.indexOf(&apos;&amp;token&apos;) &gt; -1 &amp;&amp; url.indexOf(credentials_tag) == -1 )
		{
			return url
		}

		if (! arg_credentials)
		{
			this.debug(&apos;get_asset_url:no credentials&apos;)
			// console.log(&apos;get_asset_url:arg_url=%s&apos;, arg_url)
			// console.log(&apos;get_asset_url:template=%s&apos;, template)
			// console.log(&apos;get_asset_url:url=%s&apos;, url)
			return url
		}


		if (url.indexOf(credentials_tag) &gt;= 0)
		{
			const url2 = url.replace(credentials_tag, arg_credentials.get_url_part())
			this.debug(&apos;get_asset_url:url2&apos;, url2)
			return url2
		}

		const url3 = url + &apos;?&apos; + arg_credentials.get_url_part()
		this.debug(&apos;get_asset_url:url3&apos;, url3)
		return url3
	}

	// TODO API DOC FOR create_dom_url_element(arg_dom_element, arg_tag, arg_id, arg_url, arg_type)
	create_dom_url_element(arg_dom_element, arg_tag, arg_id, arg_url, arg_type)
	{
		// SEARCH DEVAPT BOOTSTRAP SCRIPT TAG
		const devapt_bootstrap_element = document.getElementById(&apos;js-devapt-bootstrap&apos;)
		const has_bootstrap_element = devapt_bootstrap_element ? arg_dom_element == devapt_bootstrap_element.parentNode : false

		let e = document.getElementById(arg_id)
		if (e)
		{
			if (e.getAttribute(&apos;src&apos;) == arg_url)
			{
				window.devapt().monitor_asset_loading(arg_tag, arg_id, arg_url, e)
				return
			}
			e.parentNode.removeChild(e)
		}
		
		e = document.createElement(arg_tag)
		e.setAttribute(&apos;id&apos;, arg_id)
		e.setAttribute(&apos;src&apos;, arg_url)
		e.setAttribute(&apos;type&apos;, arg_type)
		// e.setAttribute(&apos;async&apos;, &apos;false&apos;)

		window.devapt().monitor_asset_loading(arg_tag, arg_id, arg_url, e)

		if (has_bootstrap_element)
		{
			arg_dom_element.insertBefore(e, devapt_bootstrap_element)

			return
		}
		arg_dom_element.appendChild(e)
	}

	// TODO API DOC FOR process_rendering_result_scripts_urls(arg_dom_element, arg_rendering_result_scripts_urls=[], arg_credentials)
	process_rendering_result_scripts_urls(arg_dom_element, arg_rendering_result_scripts_urls=[], arg_credentials)
	{
		this.debug(&apos;process_rendering_result_scripts_urls:rendering body_scripts_urls&apos;, arg_rendering_result_scripts_urls)
		
		// SEARCH DEVAPT BOOTSTRAP SCRIPT TAG
		// const devapt_bootstrap_element = document.getElementById(&apos;js-devapt-bootstrap&apos;)
		// const has_bootstrap_element = devapt_bootstrap_element ? arg_dom_element == devapt_bootstrap_element.parentNode : false

		arg_rendering_result_scripts_urls.forEach(
			(url)=&gt;{
				this.debug(&apos;process_rendering_result_scripts_urls:loop on url&apos;, url.id, url.src)

				const url_src = this.get_asset_url(url.src, &apos;script&apos;, arg_credentials ? arg_credentials : this._runtime.get_session_credentials())

				this.create_dom_url_element(arg_dom_element, &apos;script&apos;, url.id, url_src, &apos;text/javascript&apos;)
			}
		)
	}

	// TODO API DOC FOR process_rendering_result_scripts_tags(arg_dom_element, arg_rendering_result_scripts_tags=[]/*, arg_credentials*/)
	process_rendering_result_scripts_tags(arg_dom_element, arg_rendering_result_scripts_tags=[]/*, arg_credentials*/)
	{
		this.debug(&apos;process_rendering_result_scripts_tags:rendering body_scripts_tags&apos;, arg_rendering_result_scripts_tags)
		
		arg_rendering_result_scripts_tags.forEach(
			(tag)=&gt;{
				this.debug(&apos;process_rendering_result_scripts_tags:loop on tag&apos;)

				let e = document.getElementById(tag.id)
				if (e)
				{
					if (e.text == tag.content)
					{
						return
					}
					e.parentNode.removeChild(e)
				}

				e = document.createElement(&apos;script&apos;)
				e.text = tag.content
				e.setAttribute(&apos;id&apos;, tag.id)
				e.setAttribute(&apos;type&apos;, &apos;text/javascript&apos;)
				arg_dom_element.appendChild(e)
			}
		)
	}

	// TODO API DOC FOR process_rendering_result_styles_urls(arg_dom_element, arg_rendering_result_styles_urls=[], arg_credentials)
	process_rendering_result_styles_urls(arg_dom_element, arg_rendering_result_styles_urls=[], arg_credentials)
	{
		this.debug(&apos;process_rendering_result_styles_urls:rendering body_styles_urls&apos;, arg_rendering_result_styles_urls)
		
		arg_rendering_result_styles_urls.forEach(
			(url)=&gt;{
				this.debug(&apos;process_rendering_result_styles_urls:loop on url&apos;, url.id, url.href)

				const url_href = this.get_asset_url(url.href, &apos;style&apos;, arg_credentials ? arg_credentials : this._runtime.get_session_credentials())
				
				let e = document.getElementById(url.id)
				if (e)
				{
					// console.log(&apos;e exists&apos;, e)
					if (e.getAttribute(&apos;href&apos;) == url_href)
					{
						window.devapt().monitor_asset_loading(&apos;link&apos;, url.id, url_href, e)
						return
					}
					// console.log(&apos;existing e is different&apos;, e, url_href)
					e.parentNode.removeChild(e)
				}
				
				e = document.createElement(&apos;link&apos;)
				e.setAttribute(&apos;id&apos;, url.id)
				e.setAttribute(&apos;href&apos;, url_href)
				e.setAttribute(&apos;media&apos;, url.media ? url.media : &apos;all&apos;)
				e.setAttribute(&apos;rel&apos;, &apos;stylesheet&apos;)
				arg_dom_element.appendChild(e)

				window.devapt().monitor_asset_loading(&apos;link&apos;, url.id, url_href, e)
			}
		)
	}

	// TODO API DOC FOR process_rendering_result_styles_tags(arg_dom_element, arg_rendering_result_styles_tags=[]/*, arg_credentials*/)
	process_rendering_result_styles_tags(arg_dom_element, arg_rendering_result_styles_tags=[]/*, arg_credentials*/)
	{
		this.debug(&apos;process_rendering_result_styles_tags:rendering body_styles_tags&apos;, arg_rendering_result_styles_tags)
		
		arg_rendering_result_styles_tags.forEach(
			(tag)=&gt;{
				this.debug(&apos;process_rendering_result_styles_tags:loop on tag&apos;)

				let e = document.getElementById(tag.id)
				if (e)
				{
					if (e.text == tag.content)
					{
						return
					}

					e.parentNode.removeChild(e)
				}

				e = document.createElement(&apos;style&apos;)
				e.setAttribute(&apos;id&apos;, tag.id)
				e.setAttribute(&apos;type&apos;, &apos;text/css&apos;)
				e.setAttribute(&apos;media&apos;, tag.media)
				e.textContent = tag.content

				arg_dom_element.appendChild(e)
			}
		)
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
